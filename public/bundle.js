function log(e){"true"==$("#logging").slider().val()&&console.log(e)}function AudioSample(e,a){this.location=a,this.name=e,this.incomingbuffer=void 0,this.savedBuffer=void 0;var t=new XMLHttpRequest;t.open("get",a,!0),t.responseType="arraybuffer",t.onload=function(){darworms$1.audioContext.decodeAudioData(t.response,function(e){this.savedBuffer=e}.bind(this))}.bind(this),t.send(),darworms$1.audioSamples.push(this)}function drawdna(e,a,t){let r=e.clientWidth,s=e.clientHeight;(pGraphics=e.getContext("2d")).setTransform(1.5*r/2,0,0,.75*s/2,1.5*r/2,.75*s/2),pGraphics.fillStyle=darworms$1.dwsettings.cellBackground[darworms$1.dwsettings.backGroundTheme],pGraphics.strokeStyle="black",pGraphics.lineWidth=.02,pGraphics.rect(-1,-1,2,2),pGraphics.fill(),pGraphics.beginPath(),pGraphics.moveTo(xPts[0],yPts[0]);for(o=1;o<6;o+=1)pGraphics.lineTo(xPts[o],yPts[o]);pGraphics.lineTo(xPts[0],yPts[0]),pGraphics.stroke();for(var o=0,i=1;o<6;o++,i<<=1)pGraphics.setLineDash(0==(t&i)?[.02,.02]:[]),pGraphics.lineWidth=0==(t&i)?.01:.04,pGraphics.beginPath(),pGraphics.moveTo(0,0),pGraphics.lineTo(xPts[o],yPts[o]),pGraphics.stroke();pGraphics.setLineDash([])}function graphicsInit(e){wCanvas=document.getElementById("wcanvas"),wGraphics=wCanvas.getContext("2d"),resizeCanvas()}function setGrid(e,a){grid=e,timeInDraw=0,frameTimes.length=0,startFrameTimes.length=0,theGame=a}function setScale(e,a){scale=new Point(wCanvas.width/(e+1.5),wCanvas.height/(a+1))}function reScale(e,a){setScale(e,a),log(" reScaled to "+scale.format())}function clearCanvas(){wGraphics.save(),wGraphics.setTransform(1,0,0,1,0,0),wGraphics.clearRect(0,0,wCanvas.width,wCanvas.height),wGraphics.fillStyle=darworms$1.dwsettings.cellBackground[darworms$1.dwsettings.backGroundTheme],wGraphics.fillStyle="#F5F5F500",wGraphics.fillRect(0,0,wCanvas.width,wCanvas.height),wGraphics.restore()}function startGameTimer(){gameElapsedTime=-(new Date).getTime()}function stopGameTimer(){gameElapsedTime+=(new Date).getTime()}function getOffset(e){var a,t;return a=0==(1&e.y)?(e.x+.5)*scale.x+scale.x/2:(e.x+1)*scale.x+scale.x/2,t=(e.y+.5)*scale.y+scale.y/2,new Point(a,t)}function gsetTranslate(e){var a=getOffset(e);wGraphics.setTransform(scale.x,0,0,scale.y,a.x,a.y)}function drawCells(){if(grid){wGraphics.save();for(var e=0;e<grid.width;e+=1)for(var a=0;a<grid.height;a+=1)drawcell(new Point(e,a));wGraphics.restore()}}function drawcell(e){timeInDraw-=Date.now(),gsetTranslate(e);var a=grid.spokeAt(e,7);wGraphics.lineWidth=2/scale.x,wGraphics.strokeStyle=darworms$1.dwsettings.colorTable[15&a],wGraphics.fillStyle=darworms$1.dwsettings.cellBackground[darworms$1.dwsettings.backGroundTheme],wGraphics.beginPath(),wGraphics.moveTo(darworms$1.graphics.vertex_x[0],darworms$1.graphics.vertex_y[0]);for(t=1;t<6;t+=1)wGraphics.lineTo(darworms$1.graphics.vertex_x[t],darworms$1.graphics.vertex_y[t]);if(wGraphics.stroke(),wGraphics.closePath(),wGraphics.fill(),a){wGraphics.strokeStyle=darworms$1.dwsettings.colorTable[15&a],wGraphics.fillStyle=darworms$1.dwsettings.alphaColorTable[15&a],wGraphics.beginPath(),wGraphics.moveTo(darworms$1.graphics.vertex_x[0],darworms$1.graphics.vertex_y[0]);for(t=1;t<6;t+=1)wGraphics.lineTo(darworms$1.graphics.vertex_x[t],darworms$1.graphics.vertex_y[t]);wGraphics.stroke(),wGraphics.closePath(),wGraphics.fill()}wGraphics.fillStyle=darworms$1.dwsettings.alphaColorTable[15&grid.spokeAt(e,6)],wGraphics.lineWidth=2/scale.x,wGraphics.beginPath(),wGraphics.arc(0,0,.1,0,2*Math.PI,!0),wGraphics.closePath(),wGraphics.fill(),wGraphics.strokeStyle=darworms$1.dwsettings.cellBackground[1-darworms$1.dwsettings.backGroundTheme],wGraphics.lineWidth=1/scale.x,wGraphics.beginPath(),wGraphics.moveTo(darworms$1.graphics.vertex_x[0],darworms$1.graphics.vertex_y[0]);for(var t=1;t<6;t+=1)wGraphics.lineTo(darworms$1.graphics.vertex_x[t],darworms$1.graphics.vertex_y[t]);wGraphics.lineTo(darworms$1.graphics.vertex_x[0],darworms$1.graphics.vertex_y[0]),wGraphics.stroke(),wGraphics.closePath();for(var r=grid.outVectorsAt(e),s=grid.inVectorsAt(e),o=0;o<6;o+=1){if(0!=(r&darworms$1.outMask[o])){var i=darworms$1.dwsettings.colorTable[grid.spokeAt(e,o)];wGraphics.strokeStyle=i,wGraphics.lineWidth=2/scale.x,wGraphics.lineCap="round",wGraphics.beginPath(),wGraphics.moveTo(0,0),wGraphics.lineTo(xPts$1[o],yPts$1[o]),wGraphics.stroke(),wGraphics.closePath()}0!=(s&darworms$1.outMask[o])&&(wGraphics.strokeStyle=darworms$1.dwsettings.colorTable[grid.spokeAt(e,o)],wGraphics.lineWidth=2/scale.x,wGraphics.lineCap="round",wGraphics.beginPath(),wGraphics.moveTo(xPts$1[o],yPts$1[o]),wGraphics.lineTo(0,0),wGraphics.stroke(),wGraphics.closePath())}if(grid.isSink(e)){wGraphics.strokeStyle=darworms$1.dwsettings.colorTable[0];for(var n=0;n<3;n+=1){var d=(n+3)%6;wGraphics.beginPath(),wGraphics.moveTo(xPts$1[n]*asterixSize,yPts$1[n]*asterixSize),wGraphics.lineTo(xPts$1[d]*asterixSize,yPts$1[d]*asterixSize),wGraphics.stroke(),wGraphics.closePath(),wGraphics.lineTo(darworms$1.graphics.vertex_x[t],darworms$1.graphics.vertex_y[t])}}timeInDraw+=Date.now()}function drawDirtyCells(){for(var e;void 0!==(e=dirtyCells.pop());)drawcell(e)}function pushDirtyCell(e){dirtyCells.push(e)}function highlightWorm(e,a){e.state===darworms$1.gameStates.waiting&&(gsetTranslate(e.pos),wGraphics.fillStyle=darworms$1.dwsettings.cellBackground[darworms$1.dwsettings.backGroundTheme],wGraphics.beginPath(),wGraphics.arc(0,0,.2,0,2*Math.PI,!0),wGraphics.closePath(),wGraphics.fill(),wGraphics.fillStyle=darworms$1.dwsettings.alphaColorTable[e.colorIndex],wGraphics.beginPath(),wGraphics.arc(0,0,(31&darworms$1.graphics.animFrame)/31*.2,0,2*Math.PI,!0),wGraphics.closePath(),wGraphics.fill())}function initPickUI(e){log(" initPickUI"),darworms$1.pickCells=new Array;for(var a=this.grid.outVectorsAt(e.pos),t=this.grid.inVectorsAt(e.pos),r=0;r<6;r+=1)if(0==(a&darworms$1.outMask[r])&&0==(t&darworms$1.outMask[r])){var s={};s.pos=this.grid.next(e.pos,r),s.dir=r,s.color=darworms$1.dwsettings.alphaColorTable[theGame.focusWorm.colorIndex],s.wormColorIndex=theGame.focusWorm.colorIndex,darworms$1.pickCells.push(s)}}function drawPickCells(){var e=1*(127&darworms$1.graphics.animFrame)/128;1==darworms$1.dwsettings.pickDirectionUI&&e<.1&&(clearCanvas(),drawCells()),darworms$1.pickCells.forEach(function(e){drawPickCell(e.pos,e.color)}),drawPickCellOrigin(darworms$1.theGame.focusWorm.pos,darworms$1.dwsettings.alphaColorTable[darworms$1.theGame.focusWorm.colorIndex]),1==darworms$1.dwsettings.pickDirectionUI&&darworms$1.pickCells.forEach(function(e){drawExpandedTarget(e)}),darworms$1.theGame.worms.forEach(function(e,a){highlightWorm(e,a)},darworms$1.theGame)}function drawPickCell(e,a){gsetTranslate(e),wGraphics.fillStyle=darworms$1.dwsettings.cellBackground[darworms$1.dwsettings.backGroundTheme],0!==this.grid.spokeAt(e,7)&&log(" Why is an owned cell a target selection? "+e.format(e)),drawcell(e);var t=1*(63&darworms$1.graphics.animFrame)/64;wGraphics.strokeStyle=a,wGraphics.fillStyle=a,wGraphics.beginPath(),wGraphics.moveTo(darworms$1.graphics.vertex_x[0]*t,darworms$1.graphics.vertex_y[0]*t);for(var r=1;r<6;r+=1)wGraphics.lineTo(darworms$1.graphics.vertex_x[r]*t,darworms$1.graphics.vertex_y[r]*t);wGraphics.moveTo(darworms$1.graphics.vertex_x[0],darworms$1.graphics.vertex_y[0]),wGraphics.stroke(),wGraphics.closePath(),wGraphics.fill(),wGraphics.fillStyle=darworms$1.dwsettings.alphaColorTable[15&this.grid.spokeAt(e,6)]}function drawPickCellOrigin(e,a){gsetTranslate(e),wGraphics.fillStyle=darworms$1.dwsettings.cellBackground[darworms$1.dwsettings.backGroundTheme],0!==this.grid.spokeAt(e,7)&&log(" Why is an owned cell a target selection origin? "+e.format(e)),drawcell(e);var t=1*(63&darworms$1.graphics.animFrame)/64;wGraphics.strokeStyle=a,wGraphics.fillStyle=a;for(var r=this.grid.outVectorsAt(e),s=this.grid.inVectorsAt(e),o=0;o<6;o+=1)0==(r&darworms$1.outMask[o])&&0==(s&darworms$1.outMask[o])&&(wGraphics.lineWidth=3/scale.x,wGraphics.lineCap="round",wGraphics.beginPath(),wGraphics.moveTo(0,0),wGraphics.lineTo(xPts$1[o]*t,yPts$1[o]*t),wGraphics.stroke(),wGraphics.closePath())}function drawExpandedTarget(e){var a=getOffset(e.pos);wGraphics.save();const t=darworms$1.dwsettings.alphaColorTable[e.wormColorIndex];wGraphics.strokeStyle=t,wGraphics.lineWidth=4,wGraphics.setTransform(1,0,0,1,0,0),wGraphics.beginPath();var r=xPts$1[e.dir]*wCanvas.width*.75/2+wCanvas.width/2,s=yPts$1[e.dir]*wCanvas.height*.75/2+wCanvas.height/2;wGraphics.arc(r,s,20,0,2*Math.PI,!1),wGraphics.closePath(),wGraphics.stroke(),wGraphics.strokeStyle=t,wGraphics.lineWidth=2,wGraphics.moveTo(r,s),wGraphics.beginPath(),wGraphics.moveTo(r,s);var o=1*(127&darworms$1.graphics.animFrame)/128;wGraphics.lineTo(r+(a.x-r)*o,s+(a.y-s)*o),wGraphics.closePath(),wGraphics.stroke(),wGraphics.restore()}function selectDirection(e){1==darworms$1.dwsettings.pickDirectionUI?selectLargeUIDirection(e):selectSmallUIDirection(e)}function selectSmallUIDirection(e){darworms$1.pickCells.forEach(function(a){var t=getOffset(a.pos),r=e.absDiff(t),s=new Point(e.x-t.x,e.y-t.y);r.x<scale.x/2&&r.y<scale.y/2&&this.gameState===darworms$1.gameStates.waiting&&(log(" target hit delta: "+s.format()),setDNAandResumeGame(a.dir))},darworms$1.theGame)}function setDNAandResumeGame(e){theGame.focusWorm.dna[63&theGame.focusValue]=e,theGame.focusWorm.numChoices+=1,darworms$1.theGame.gameState=darworms$1.gameStates.running,clearCanvas(),drawCells()}function selectLargeUIDirection(e){for(var a,t=darworms$1.theGame.grid.stateAt(theGame.focusWorm.pos),r=1e5,s=-1,o=0;o<6;o+=1)if(0==(t&darworms$1.outMask[o])){const t=new Point(darworms$1.theGame.xPts[o]*wCanvas.width*.75/2+wCanvas.width/2,darworms$1.theGame.yPts[o]*wCanvas.height*.75/2+wCanvas.height/2);(a=t.dist(e))<r&&(r=a,s=o)}r<wCanvas.width/8&&s>=0&&setDNAandResumeGame(s)}function animateDyingWorms(){for(var e=0;e<4;e+=1){var a=e+darworms$1.graphics.uiFrames&3;theGame.worms[a].state==darworms$1.wormStates.dying&&animateDyingCell(theGame.worms[a])}}function animateDyingCell(e){drawcell(e.pos),drawShrikingOutline(e)}function drawShrikingOutline(e){var a=(darworms$1.graphics.dyningAnimationFrames-(darworms$1.graphics.uiFrames-e.diedAtFrame))/darworms$1.graphics.dyningAnimationFrames;gsetTranslate(e.pos),wGraphics.strokeStyle=darworms$1.dwsettings.alphaColorTable[e.colorIndex],wGraphics.lineWidth=.1,wGraphics.fillStyle=darworms$1.dwsettings.alphaColorTable[e.colorIndex],wGraphics.beginPath(),wGraphics.moveTo(darworms$1.graphics.vertex_x[0]*a,darworms$1.graphics.vertex_y[0]*a);for(var t=1;t<6;t+=1)wGraphics.lineTo(darworms$1.graphics.vertex_x[t]*a,darworms$1.graphics.vertex_y[t]*a);wGraphics.lineTo(darworms$1.graphics.vertex_x[0]*a,darworms$1.graphics.vertex_y[0]*a),wGraphics.closePath(),wGraphics.stroke()}function showTimes(){var e=1e8,a=0,t=0,r=0,s=0,o=0;log("frameTimes.length "+frameTimes.length);for(var i=0;i<frameTimes.length;i+=1)r+=1,frameTimes[i]>a&&(a=frameTimes[i]),frameTimes[i]<e&&(e=frameTimes[i]),s+=frameTimes[i];r>0&&(t=Math.round(s/r*100)/100);var n=(new Date).getTime()-startFrameTimes[0],d=Math.round(100*s/n*100)/100;gameElapsedTime>0&&(o=Math.round(1e3*r/gameElapsedTime*100)/100),document.getElementById("wormframes").innerHTML=r,document.getElementById("wormmintime").innerHTML=e,document.getElementById("wormmaxtime").innerHTML=a,document.getElementById("wormavetime").innerHTML=t,document.getElementById("wormframetargettime").innerHTML=1e3/$("#fps").val(),document.getElementById("wormfps").innerHTML=o,e=1e6,a=0,r=0,s=0,t=0;var m=0;for(i=1;i<startFrameTimes.length;i+=1)r+=1,(m=startFrameTimes[i]-startFrameTimes[i-1])>a&&(a=m),m<e&&(e=m),s+=m;r>0&&(t=Math.round(s/r*100)/100),document.getElementById("wormframemintime").innerHTML=e,document.getElementById("wormframemaxtime").innerHTML=a,document.getElementById("wormframeavetime").innerHTML=t,document.getElementById("wormframepercenttime").innerHTML=d,document.getElementById("wormframetotaltime").innerHTML=timeInDraw/1e3}function resizeCanvas(){var e=$("#wcanvas"),a=document.getElementById("wcanvas"),t=$("#scorecanvas"),r=($("#navcontainer"),$("#footerbar"),$(window).width()),s=$(window).height();if(r/(s-140)>1.5&&(r=s-140),s>400)e.css({width:r-20+"px",height:s-140+"px"}),t.css({width:r-20+"px",height:"30px"});else{var o=Math.floor(.7*r);e.css({width:o+"px",height:s-110+"px"}),t.css({width:o+"px"})}a.height=s-140,a.width=r,"1"===$("#debug").slider().val()&&alert(" Resize "+r+" x "+s+" debug "+$("#debug").slider().val()),darworms$1.theGame&&(setScale(this.grid.width,this.grid.height),darworms$1.theGame.needsRedraw=!0,clearCanvas(),drawCells())}function scoreCanvasInit(e){scoreCanvas=document.getElementById("scorecanvas"),(scorectx=scoreCanvas.getContext("2d")).font="bold 18px sans-serif",scorectx.shadowColor="rgb(190, 190, 190)",scorectx.shadowOffsetX=3,scorectx.shadowOffsetY=3}function clearScore(e,a){var t=scoreCanvas.width/a;scorectx.fillStyle=darworms$1.dwsettings.cellBackground[0],scorectx.shadowOffsetX=0,scorectx.shadowOffsetY=0,scorectx.fillRect(t*e,0,t,scoreCanvas.height)}function scoreStartx(e,a,t){var r=scoreCanvas.width/a;return r*e+r/2-scorectx.measureText(t).width/2}function updateScores(e){e.forEach(function(e,a){void 0!==e&&e.shouldDrawScore()&&(clearScore(a,4),scorectx.fillStyle=darworms$1.dwsettings.colorTable[a+1],scorectx.fillText(e.score,scoreStartx(a,4,e.score.toString()),15))})}function pick(e,...a){return a.reduce((a,t)=>{e.hasOwnProperty(t)&&(a[t]=e[t]);return a},{})}function addPick(e,a,...t){return Object.assign(e,pick(a,...t))}function gameName(e){var a=new Date(e.createdAt).toString();let t=0;return e.players.forEach(function(e,a){" None "!==e.typeName&&t++}),a=a.substr(0,a.indexOf("GMT")),a+="["+e.width+"x"+e.width+": "+t,a+=1==t?" player]":" players]"}function emailGame(e){var a="mailto:?subject="+encodeURIComponent("Darworms Game ")+"&body="+encodeURIComponent("Darworms is a unique, free web strategy territoty capture game. Select everything below and paste it into a browser address bar \n\n")+encodeURIComponent(darworms.host)+encodeURIComponent("?darwormsgame=")+encodeURIComponent(e);log("url: "+a),window.open(a)}function encodeGame(e,a,t,r){log(" encodeGame 0 "),now=new Date,(gameObj={version:r}).createdAt=now.valueOf(),gameObj=addPick(gameObj,e,"numMoves","numTurns"),gameObj=addPick(gameObj,e.grid,"width"),gameObj=addPick(gameObj,a,"backGroundTheme","doAnimations","doAudio","gridGeometry","fixedInitPos","pickDirectionUI","masterAudioVolume"),(gameObj=addPick(gameObj,t,"fps")).players=[],e.worms.forEach(function(e,a){var t={index:a};e.toText(),t=addPick(t,e,"typeName","startingPos","name","score","instrument","musickeyName","MusicScale"),gameObj.players.push(t)}),gameTxt=JSON.stringify(gameObj),gameUrl=encodeURIComponent(gameTxt);let s=decodeURIComponent(gameUrl),o=JSON.parse(s),i=JSON.stringify(o);return log("before: "+gameTxt),log("after:  "+i),gameTxt}function loadGames(){const e=JSON.parse(localStorage.getItem("darwormgames"));darworms.savedgames=e||[],darworms.savedgames.forEach(function(e,a){const t=JSON.parse(e),r=(new Date(t.createdAt),'<li data-icon="delete" data-split-icon="delete-black"><a class="loadMe" value='+a+">"+gameName(t)+"</a><a value="+a+' data-icon="star" data-split-icon="delete-black" class="deleteMe" ></a></li>');$("#savedgames").append(r).listview("refresh"),log(" liStr: "+r)}),$(".deleteMe").on("click",function(e){log(" deleteMe clicked"),log($(this).attr("value"));let a=parseInt($(this).attr("value"));a>=0&&a<darworms.savedgames.length&&darworms.savedgames.splice(a,1),localStorage.setItem("darwormgames",JSON.stringify(darworms.savedgames)),refreshSavedGames()}),$(".loadMe").on("click",function(e){log(" loadMe clicked"),log($(this).attr("value"));let a=parseInt($(this).attr("value"));if(a>=0&&a<darworms.savedgames.length){darworms.main.injectSettings(darworms.savedgames[a]);updateScores(darworms.main.gWorms),$.mobile.changePage("#playpage")}})}function freeGames(){const e=$("#savedgames")[0];for(;e.firstChild;)e.removeChild(e.firstChild)}function saveGame(e){log(" saveGame "),darworms.savedgames.push(e),localStorage.setItem("darwormgames",JSON.stringify(darworms.savedgames)),refreshSavedGames()}function refreshSavedGames(){const e=$("#savedgames")[0];for(;e.firstChild;)e.removeChild(e.firstChild);loadGames()}function makeMoves(){var e=(new Date).getTime();startFrameTimes.push(e),darworms$1.theGame.needsRedraw&&(drawCells(),darworms$1.theGame.needsRedraw=!1),darworms$1.theGame.gameState!=darworms$1.gameStates.over&&!1===darworms$1.theGame.makeMove(darworms$1.dwsettings.doAnimations)&&(stopGameTimer(),log(" Game Over"),clearInterval(darworms$1.graphics.timer),$("#startpause").text("Start Game"),showTimes(),updateScores(darworms$1.theGame.worms),darworms$1.theGame.gameState=darworms$1.gameStates.over,darworms$1.gameTxt=encodeGame(darworms$1.theGame,darworms$1.dwsettings,darworms$1.graphics,darworms$1.version)),darworms$1.dwsettings.doAnimations&&(drawDirtyCells(),animateDyingWorms(),darworms$1.theGame.getAvePos()),updateScores(darworms$1.theGame.worms);var a=(new Date).getTime()-e;frameTimes.push(a)}function gameInit(){log(" wCanvas,width: "+wCanvas.width),graphicsInit(this),scoreCanvasInit(),nextToMove=0}class Point{constructor(e,a){this.x=e,this.y=a}isEqualTo(e){return this.x==e.x&&this.y==e.y}add(e){this.x=this.x+e.x,this.y=this.y+e.y}dist(e){return Math.sqrt((this.x-e.x)*(this.x-e.x)+(this.y-e.y)*(this.y-e.y))}absDiff(e){return new Point(Math.abs(this.x-e.x),Math.abs(this.y-e.y))}wrap(e,a){this.x>=e&&(this.x=this.x-e),this.x<0&&(this.x=this.x+e),this.y>=a&&(this.y=this.y-a),this.y<0&&(this.y=this.y+a)}format(){return"("+this.x+","+this.y+")"}print(){log(" Private class variable "+privateString)}}var darworms$1={version:"0.9.3",host:"https://darworms.com",compassPts:["e","se","sw","w","nw","ne","unSet","isTrapped"],gameStates:{over:0,running:1,waiting:2,paused:3,animToUI:4,animFromUI:5},wormStates:{dead:0,moving:1,paused:2,sleeping:3,dying:4},wormStateNames:["dead","moving","paused","sleeping","dying"],initialWormStates:[3,2,2,2],themes:["c","d","e","f"],selectedIdx:0,gameStateNames:["over","running","waiting","paused","to_ui","from_ui"],outMask:[1,2,4,8,16,32],inMask:[8,16,32,1,2,4],colorNames:["red","green","blue","yellow"],buttonSelectors:["#p1button","#p2button","#p3button","#p4button"],buttonLSelectors:["#p1Lbutton","#p2Lbutton","#p3Lbutton","#p4Lbutton"],inDir:[3,4,5,0,1,2],wCanvasPixelDim:[0,0],wCanvasRef:void 0,minTwoColumnWidth:480,leftColumnWidth:320,screens:{},pickCells:[],graphics:{timer:void 0,scorectx:void 0,animFrame:0,uiFrames:0,rawFrameCount:0,drawFrameCount:0,uiFrameCount:0,xPts:[.5,.25,-.25,-.5,-.25,.25],yPts:[0,.5,.5,0,-.5,-.5],fps:4,frameInterval:33.33333,uifps:30,uiInterval:33.33333,startTime:0,now:0,then:0,uiThen:0,elapsed:0,uiElapsed:0,vertex_x:[.5,.5,0,-.5,-.5,0],vertex_fudge:.12,vertex_y:[.3125,-.3125,-.6875,-.3125,.3125,.6875],hexSize:1,sqrt3:Math.sqrt(3),dyningAnimationFrames:8},selectedDarworm:0,notes:{C1:0,CS:1,DF:1,D:2,DS:3,EF:3,E:4,F:5,FS:6,GF:6,G:7,GS:8,FF:8,AF:8,A:9,AS:10,BF:10,B:11,C2:12},dwsettings:{forceInitialGridSize:!0,largeGridSize:18,smallGridSize:10,minLargeWidth:800,isLargeScreen:!0,doAudio:1,fixedInitPos:!0,pickDirectionUI:0,noWhere:void 0,gridGeometry:"torus",codons:{e:0,ne:1,nw:2,w:3,sw:4,se:5,unSet:6,isTrapped:7},colorTable:["#000000","#EE0000","#00EE00","#0404EE","#D0A000","#448833","#443388","#338844","#FF1C0A","#1CFF0A","#1C0AFF","#0AFF1C","#884433","#448833","#443388","#338844"],alphaColorTable:["rgba(  0,   0,   0, 0.2)","rgba(  238,   0,   0, 0.4)","rgba(    0, 128,   0, 0.4)","rgba(    0,   0, 238, 0.4)","rgba(  200, 200, 0, 0.4)","#FFD70080","#5fa40480","#44338880","#33884480","#FF1C0A80","#1CFF0A80","#1C0AFF80","#0AFF1C80","#88443380","#44883380","#44338880","#33884480"],backGroundTheme:0,doAnimations:!0,gridBackground:["#F5F5F5","#404040"],cellBackground:["#F5F5F5","#404040"],masterAudioVolume:.3,dologging:!1,gridSize:18},images:{},audioContext:void 0,masterGainNode:void 0,audioPanner:void 0,audioSamples:[],audioPlaybackRates:[],audioFrequencies:[],gameTxt:null};window.addEventListener("load",function(){window.onerror=function(e,a,t){alert(e+" "+a+" "+t)},$("[data-darworm='selector']").on("pageshow",darworms$1.main.setupEditPage),$("[data-darworm='selector']").on("pagehide",darworms$1.main.setSelectedDarwormType),$("#settingspage").on("pageshow",darworms$1.main.showSettings),$("#settingspage").on("pagebeforeshow",darworms$1.main.setupGridGeometry),$("#settingspage").on("pagehide",darworms$1.main.applySettings),$("#playpage").on("pageshow",darworms$1.main.initPlayPage),$("#playpage").on("pagehide",darworms$1.main.leavePlayPage),$("#edit-darworm-page").on("pageshow",darworms$1.main.initEditPage),$("#edit-darworm-page").on("pagehide",darworms$1.main.leaveditPage),$("#loadsavepage").on("pageshow",darworms$1.main.loadSavedGames),$("#loadsavepage").on("pagehide",darworms$1.main.freeSavedGames),$("#tutorialpopup").popup({afterclose:function(e,a){log(" afterclose even fired"+$("#tutorialpopup input[type=checkbox]").prop("checked")),$("#tutorialpopup input[type=checkbox]").prop("checked")&&(darworms$1.theGame.focusWorm.showTutorial=!1)}}),log("About to call darworms.main.init()"),window.darworms=darworms$1,darworms$1.main.init()}),AudioSample.prototype.playSample=function(e,a){var t;void 0!==darworms$1.audioContext&&void 0!==this.savedBuffer&&((t=darworms$1.audioContext.createBufferSource()).buffer=this.savedBuffer,darworms$1.masterGainNode.gain.value=darworms$1.dwsettings.masterAudioVolume,t.connect(darworms$1.masterGainNode),void 0!==darworms$1.audioPanner?(darworms$1.masterGainNode.connect(darworms$1.audioPanner),darworms$1.audioPanner.connect(darworms$1.audioContext.destination)):darworms$1.masterGainNode.connect(darworms$1.audioContext.destination),void 0!==darworms$1.audioPanner&&(darworms$1.audioPanner.pan.value=.8*a),t.start(0),e&&(t.playbackRate.value=e))};const evenRowVec=[{x:1,y:0},{x:0,y:1},{x:-1,y:1},{x:-1,y:0},{x:-1,y:-1},{x:0,y:-1}],oddRowVec=[{x:1,y:0},{x:1,y:1},{x:0,y:1},{x:-1,y:0},{x:0,y:-1},{x:1,y:-1}],spokeMask=[4294967280,4294967055,4294963455,4294905855,4293984255,4279238655,4043309055,268435455],sinkMask=134217728;class Grid{constructor(e,a){this.width=Math.floor(e),this.height=Math.floor(a),this.cells=new Array(e*a),this.colors=new Array(e*a),this.clear()}clear(){for(e=0;e<this.cells.length;e++)this.cells[e]=0;for(e=0;e<this.colors.length;e++)this.colors[e]=0;if("reflect"==darworms$1.dwsettings.gridGeometry){for(var e=0;e<this.width;e+=1){var a=new Point(e,0),t=new Point(e,this.height-1);this.setValueAt(a,this.valueAt(a)|darworms$1.outMask[4]|darworms$1.outMask[5]),this.setValueAt(a,this.valueAt(a)|(63&this.valueAt(a))<<8),this.setSpokeAt(a,4,0),this.setSpokeAt(a,5,0),this.setSpokeAt(a,6,0),this.setValueAt(t,this.valueAt(t)|darworms$1.outMask[1]|darworms$1.outMask[2]),this.setValueAt(t,this.valueAt(t)|(63&this.valueAt(t))<<8),this.setSpokeAt(t,1,0),this.setSpokeAt(t,2,0),this.setSpokeAt(t,6,0)}for(var r=0;r<this.height;r+=1){var s=new Point(0,r),o=new Point(this.width-1,r);0==(1&r)?(this.setValueAt(s,this.valueAt(s)|darworms$1.outMask[2]|darworms$1.outMask[3]|darworms$1.outMask[4]),this.setValueAt(s,this.valueAt(s)|(63&this.valueAt(s))<<8),this.setSpokeAt(s,2,0),this.setSpokeAt(s,3,0),this.setSpokeAt(s,4,0),this.setSpokeAt(s,6,0),this.setValueAt(o,this.valueAt(o)|darworms$1.outMask[0]),this.setValueAt(o,this.valueAt(o)|(63&this.valueAt(o))<<8),this.setSpokeAt(o,0,0),this.setSpokeAt(o,6,0)):(this.setValueAt(s,this.valueAt(s)|darworms$1.outMask[3]),this.setValueAt(s,this.valueAt(s)|(63&this.valueAt(s))<<8),this.setSpokeAt(s,3,0),this.setSpokeAt(s,6,0),this.setValueAt(o,this.valueAt(o)|darworms$1.outMask[5]|darworms$1.outMask[0]|darworms$1.outMask[1]),this.setValueAt(o,this.valueAt(o)|(63&this.valueAt(o))<<8),this.setSpokeAt(o,5,0),this.setSpokeAt(o,0,0),this.setSpokeAt(o,1,0),this.setSpokeAt(o,6,0))}}}valueAt(e){return this.cells[e.y*this.width+e.x]}hexValueAt(e){return" 0x"+this.valueAt(e).toString(16)}stateAt(e){return 63&this.valueAt(e)}outVectorsAt(e){return this.valueAt(e)>>8&63}inVectorsAt(e){return this.valueAt(e)>>16&63}spokeAt(e,a){return this.colors[e.y*this.width+e.x]>>>4*a&7}colorsAt(e){return this.colors[e.y*this.width+e.x]}setSpokeAt(e,a,t){this.colors[e.y*this.width+e.x]=this.colors[e.y*this.width+e.x]&spokeMask[a]|(15&t)<<4*a}setValueAt(e,a){this.cells[e.y*this.width+e.x]=a}setSinkAt(e){this.cells[e.y*this.width+e.x]=this.cells[e.y*this.width+e.x]^sinkMask}isSink(e){return 0!=(this.cells[e.y*this.width+e.x]&sinkMask)}isInside(e){return e.x>=0&&e.y>=0&&e.x<this.width&&e.y<this.height}move(e,a,t,r){0!=(this.inVectorsAt(a)&darworms$1.inMask[t])&&(alert(" Attempted to eat eaten spoke at "+a.format()),log("  ("+a.x+","+a.y+") dir: "+t+" value: "),log("Attempted to eat eaten spoke at "+a.format()+" dir "+t+" value: 0x"+this.valueAt(a).toString(16))),this.setValueAt(a,this.valueAt(a)|darworms$1.inMask[t]|darworms$1.inMask[t]<<16),this.setValueAt(e,this.valueAt(e)|darworms$1.outMask[t]|darworms$1.outMask[t]<<8),this.setSpokeAt(e,t,r),this.setSpokeAt(e,6,r),this.setSpokeAt(a,darworms$1.inDir[t],r),this.setSpokeAt(a,6,r);var s=0;return 63===this.stateAt(a)&&(this.setSpokeAt(a,6,r),this.setSpokeAt(a,7,r),s+=1),63===this.stateAt(e)&&(this.setSpokeAt(e,6,r),this.setSpokeAt(e,7,r),s+=1),s}next(e,a){var t=new Point(e.x,e.y);return 0==(1&e.y)?t.add(evenRowVec[a]):t.add(oddRowVec[a]),"falloff"==darworms$1.dwsettings.gridGeometry&&(t.x<0||t.x>this.width-1||t.y<0||t.y>this.height-1)?darworms$1.dwsettings.noWhere:(t.x<0&&(t.x=this.width-1),t.x>this.width-1&&(t.x=0),t.y<0&&(t.y=this.height-1),t.y>this.height-1&&(t.y=0),t)}each(e){for(var a=0;a<this.height;a++)for(var t=0;t<this.width;t++){var r=new Point(t,a);e(r,this.valueAt(r))}}logSpokesAt(e){log("[ "+e.x+","+e.y+"] val = "+this.colorsAt(e).toString(16));for(var a=0;a<8;a+=1)log("   spoke: "+a+" colorindex"+this.spokeAt(e,a))}logValueAt(e){log("[ "+e.x+","+e.y+"] val = 0x"+this.hexValueAt(e)+this.dirList(this.hexValueAt(e))+" outVectors = 0x"+this.outVectorsAt(e).toString(16)+this.dirList(this.outVectorsAt(e))+" inVectors = 0x"+this.inVectorsAt(e).toString(16))}formatStateAt(e){return" x "+e.x+" y "+e.y+" state 0x"+this.stateAt(e).toString(16)}dirList(e){for(var a=" directions ",t=0;t<6;t+=1)0!=(e&darworms$1.outMask[t])&&(a=a+" "+darworms$1.compassPts[t]);return a}}const musicalkeys={AMajor:[darworms$1.notes.A,darworms$1.notes.B,darworms$1.notes.CS,darworms$1.notes.D,darworms$1.notes.E,darworms$1.notes.FS,darworms$1.notes.GS],BMajor:[darworms$1.notes.B,darworms$1.notes.CS,darworms$1.notes.DS,darworms$1.notes.E,darworms$1.notes.FS,darworms$1.notes.GS,darworms$1.notes.AS],CMajor:[darworms$1.notes.C1,darworms$1.notes.D,darworms$1.notes.E,darworms$1.notes.F,darworms$1.notes.G,darworms$1.notes.A,darworms$1.notes.B],CMinor:[darworms$1.notes.C1,darworms$1.notes.D,darworms$1.notes.EF,darworms$1.notes.F,darworms$1.notes.G,darworms$1.notes.AF,darworms$1.notes.BF],DMajor:[darworms$1.notes.D,darworms$1.notes.E,darworms$1.notes.FS,darworms$1.notes.G,darworms$1.notes.A,darworms$1.notes.B,darworms$1.notes.CS],EMajor:[darworms$1.notes.E,darworms$1.notes.FS,darworms$1.notes.GS,darworms$1.notes.A,darworms$1.notes.B,darworms$1.notes.CS,darworms$1.notes.DS],FMajor:[darworms$1.notes.F,darworms$1.notes.G,darworms$1.notes.A,darworms$1.notes.BF,darworms$1.notes.C2,darworms$1.notes.D,darworms$1.notes.E],GMajor:[darworms$1.notes.G,darworms$1.notes.A,darworms$1.notes.B,darworms$1.notes.C2,darworms$1.notes.D,darworms$1.notes.E,darworms$1.notes.FS]};class Worm{constructor(e,a){this.colorIndex=e,this.dna=new Array(64),this.state=a,this.nMoves=0,this.score=0,this.prevScore=0,this.numChoices=0,this.died=!1,this.name="",this.wType=0,this.typeName="",this.directionIndex=0,this.diedAtFrame=0,this.showTutorial=!0,this.musickeyName="CMajor",this.MusicScale=[],this.audioSamplesPtrs=[],this.pos=new Point(-1,-1),this.startingPos=new Point(-1,-1);for(var t=0;t<64;t+=1)this.dna[t]=darworms$1.dwsettings.codons.unSet;this.dna[63]=darworms$1.dwsettings.codons.isTrapped,this.numChoices=1;for(var r=0;r<6;r+=1)this.dna[63^1<<r]=r,this.numChoices+=1;this.randomize(),this.toText()}init(e){if(this.nMoves=0,this.score=0,this.prevScore=0,this.MusicScale=musicalkeys.CMajor,0===e&&(this.state=3),1===e){for(var a=0;a<64;a+=1)this.dna[a]=darworms$1.dwsettings.codons.unSet;this.dna[63]=darworms$1.dwsettings.codons.isTrapped,this.numChoices=1;for(var t=0;t<6;t+=1)this.dna[63^1<<t]=t,this.numChoices+=1;this.randomize()}if(2===e&&(this.state=2),3===e){for(var r=0;r<64;r+=1)this.dna[r]=darworms$1.dwsettings.codons.unSet;this.dna[63]=darworms$1.dwsettings.codons.isTrapped,this.numChoices=1;for(var s=0;s<6;s+=1)this.dna[63^1<<s]=s,this.numChoices+=1;this.state=2}this.toText()}setNotes(e){this.instrument=e,this.audioSamplesPtrs.length=0;for(var a=0;a<7;a+=1)this.audioSamplesPtrs.push(e)}setKey(e){log(" keyname: "+e),this.musickeyName=e,this.MusicScale=musicalkeys[e]}playScale(){for(var e=0;e<7;e+=1){darworms$1.directionIndex=e;var a=this.MusicScale;a.sort(function(e,a){return e-a}),setTimeout(function(e,a,t){e.audioSamplesPtrs[a]>=0&&darworms$1.audioSamples[e.audioSamplesPtrs[a]].playSample(darworms$1.audioPlaybackRates[t[a]],0)},500*e,this,e,a)}}getMoveDir(e){return 63===e?(this.state=wormStates.dead,this.died=!0,6):this.dna[63&e]}shouldDrawScore(){return this.score!==this.prevScore||this.nMoves<=2?(this.prevScore=this.score,!0):!!this.died&&(this.died=!1,!0)}randomize(){for(var e,a=0;a<63;a+=1)if(this.dna[a]===darworms$1.dwsettings.codons.unSet){for(var t=0;t<1e3;t+=1)if(e=Math.floor(6*Math.random()),0==(a&darworms$1.outMask[e])){this.dna[a]=e,this.numChoices+=1;break}this.dna[a]===darworms$1.dwsettings.codons.unSet&&log("Error we rolled craps 10,000 times in a row")}this.toText()}log(){log(" Worm State: "+darworms$1.wormStateNames[this.state]+" at "+(void 0!==this.pos?this.pos.format():"position Undefined"))}place(e,a,t){this.pos=t,this.startingPos=t,this.nMoves=0,this.score=0,this.state=e,log(" placing worm   i = "+this.colorIndex+" state "+e+" "+this.numChoices+" of 64 possible moves defined")}dump(){this.log();for(var e=0;e<64;e+=1){log(" dna"+e+" = "+darworms$1.compassPts[this.dna[e]]);for(var a=[],t=0;t<6;t+=1)0!=(e&darworms$1.outMask[t])&&a.push(darworms$1.compassPts[t]);log(" dna"+e+" "+a+" = "+darworms$1.compassPts[this.dna[e]])}}toText(){this.name="";for(var e=0;e<64;e+=1)0===this.dna[e]&&(this.name+="A"),1===this.dna[e]&&(this.name+="B"),2===this.dna[e]&&(this.name+="C"),3===this.dna[e]&&(this.name+="D"),4===this.dna[e]&&(this.name+="E"),5===this.dna[e]&&(this.name+="F"),6===this.dna[e]&&(this.name+="?"),7===this.dna[e]&&(this.name+="X"),this.dna[e]>7&&(this.name+="#");return this.name}fromText(e){if(!/^[ABCDEF\?]{63}X$/.test(e))return!1;for(var a=!0,t=0;t<63;t+=1){switch(e.charAt(t)){case"A":this.dna[t]=0;break;case"B":this.dna[t]=1;break;case"C":this.dna[t]=2;break;case"D":this.dna[t]=3;break;case"E":this.dna[t]=4;break;case"F":this.dna[t]=5;break;case"?":this.dna[t]=6;break;default:return alert(" illegal dna string at position "+(t+1)),!1}0!=(1<<this.dna[t]&t)&&6!==this.dna[t]&&(alert("illegal direction "+e.charAt(t)+"("+darworms$1.compassPts[this.dna[t]]+")given for cell "+t),a=!1)}return a&&this.toText(),a}emailDarworm(){log("Emailing: "+this.toText());var e="mailto:?subject="+encodeURIComponent("Check out this cool Darworm")+"&body="+encodeURIComponent("Darworms is a free web game available at \n")+encodeURIComponent(darworms$1.host+"\n")+encodeURIComponent("You can copy the darworm string below and then go to the game and paste the text into one of the players\n")+encodeURIComponent(this.toText());log("url: "+e),window.open(e)}}const xPts=[.8,.4,-.4,-.8,-.4,.4],yPts=[0,.67,.67,0,-.67,-.67];let pGraphics=null;var wGraphics,wCanvas,scale,grid;let xPts$1=[1,.5,-.5,-1,-.5,.5],yPts$1=[0,1,1,0,-1,-1],asterixSize=.2,timeInDraw=0,gameElapsedTime=0,frameTimes=[],startFrameTimes=[],dirtyCells=[],theGame=null;var scoreCanvas,scorectx;let gameObj={},gameTxt="",gameUrl="";var nextToMove,focusPoint;const maxpan=.8;class Game{constructor(e,a){wCanvas.width=$("#wcanvas").width(),wCanvas.height=$("#wcanvas").height(),this.gameState=darworms$1.gameStates.over,this.grid=new Grid(e,a),setGrid(this.grid,this),this.numTurns=0,this.numMoves=0,this.activeIndex=0,setScale(e,a),log(" new Game scale set to "+scale.format()),this.origin=new Point(e>>1,a>>1),focusPoint=this.origin,this.worms=[],this.needsRedraw=!0,this.avePos=new Point(0,0),this.focusWorm=null,this.focusValure=null,this.xPts=[1,.5,-.5,-1,-.5,.5],this.yPts=[0,1,1,0,-1,-1],(scale.x<20||scale.y<20)&&($("#pickDirectionUI").slider().val(1),$("#pickDirectionUI").slider("refresh"),darworms$1.dwsettings.pickDirectionUI=1),log(" Scale: "+scale.format()+"darworms.dwsettings.pickDirectionUI: "+darworms$1.dwsettings.pickDirectionUI),this.zoomFrame=0,this.startx=0,this.starty=0,this.endx=0,this.endy=0,this.startscale=1,this.endScale=1,this.targetZoomFrames=60,this.asterixSize=.2,this.bullseyeoffset=new Point(0,0),this.focusWorm=null}updateScale(e,a){setScale(this.grid.width,this.grid.height),log("updateScale "+scale.format())}log(){log(" Game grid size  "+new Point(this.grid.width,this.grid.height).format()),log(" Game Canvas size  "+new Point(wCanvas.width,wCanvas.height).format()),log(" Game scale "+scale.format());for(var e=0;e<this.worms.length;e+=1)log(" Game worm "+e+" :  "+this.worms[e].state+" at "+this.worms[e].pos.format()+" value:"+this.grid.hexValueAt(this.worms[e].pos))}printNonEmpty(){this.grid.each(function(e,a){a>0&&log("NonEmpty "+e.format()+" value: 0x"+a.toString(16))})}initGame(){clearCanvas(),this.grid.clear(),setGrid(this.grid,this),drawCells(),startGameTimer(),this.numMoves=0,this.numTurns=0,this.timeInDraw=0}addWorm(e){e.pos=this.origin,e.nMoves=0,e.score=0,e.state=darworms$1.wormStates.paused,this.worms.push(e)}getAvePos(e){var a=0;this.avePos.x=0,this.avePos.y=0;for(var t=0;t<this.worms.length;t+=1){var r=this.worms[t];r.state===darworms$1.wormStates.moving&&(this.avePos.x=this.avePos.x+r.pos.x,this.avePos.y=this.avePos.y+r.pos.y,a+=1)}a>1&&(this.avePos.x=Math.floor(this.avePos.x/a),this.avePos.y=Math.floor(this.avePos.y/a))}makeMove(e){var a=0;if(this.gameState!==darworms$1.gameStates.waiting){for(var t=nextToMove;t<this.worms.length;t+=1){var r=this.worms[t];if(darworms$1.theGame.activeIndex=t,r.state!==darworms$1.wormStates.sleeping){var s=this.grid.stateAt(r.pos);if(63==s)r.state!=darworms$1.wormStates.dead&&r.state!=darworms$1.wormStates.dying&&(darworms$1.dwsettings.doAnimations&&1==darworms$1.dwsettings.doAudio&&darworms$1.audioSamples[darworms$1.audioSamples.length-1]&&darworms$1.audioSamples[darworms$1.audioSamples.length-1].playSample(1,0),r.state=darworms$1.dwsettings.doAnimations?darworms$1.wormStates.dying:darworms$1.wormStates.dead,r.diedAtFrame=darworms$1.graphics.uiFrames,log(" darworm "+r.colorIndex+" dying at frame: "+darworms$1.graphics.animFrame)),r.state==darworms$1.wormStates.dying&&darworms$1.graphics.uiFrames-r.diedAtFrame>darworms$1.graphics.dyningAnimationFrames&&(r.state=darworms$1.wormStates.dead,log(" darworm "+r.colorIndex+" dead at frame: "+darworms$1.graphics.animFrame));else{var o=r.getMoveDir(s);if(o===darworms$1.dwsettings.codons.unSet){if(this.gameState=darworms$1.gameStates.waiting,focusPoint=r.pos,darworms$1.theGame.focusWorm=r,darworms$1.theGame.focusValue=s,darworms$1.theGame.focusWorm.showTutorial){$("input[type='checkbox']").attr("checked",!1);var i=["#p1button","#p2button","#p3buton","#p4button"];$("#tutorialpopup").popup("option","theme",darworms$1.themes[darworms$1.theGame.activeIndex]),log(" init popup here"),drawdna(document.getElementById("popupcanvas"),r,s),$("#tutorialpopup").popup("open",{positionTo:i[darworms$1.theGame.activeIndex]})}return nextToMove=t,this.numMoves=this.numMoves+1,r.nMoves=r.nMoves+1,drawDirtyCells(),initPickUI(r),!0}pushDirtyCell(r.pos);var n=this.grid.next(r.pos,o);if(n.isEqualTo(darworms$1.dwsettings.noWhere))r.state=darworms$1.wormStates.dead,r.died=!0;else{var d=this.grid.move(r.pos,n,o,r.colorIndex);if(r.score=r.score+d,this.numMoves=this.numMoves+1,r.nMoves=r.nMoves+1,r.pos=n,pushDirtyCell(n),1==darworms$1.dwsettings.doAudio&&e){let e=(r.pos.x-darworms$1.theGame.grid.width/2)/(darworms$1.theGame.grid.width/2)*.8;void 0!==r.audioSamplesPtrs[o]&&r.audioSamplesPtrs[o]>=0&&darworms$1.audioSamples[r.audioSamplesPtrs[o]].playSample(darworms$1.audioPlaybackRates[r.MusicScale[1==d?6:o]],e)}}}r.state!==darworms$1.wormStates.dead&&(a+=1)}}return nextToMove=0,this.numTurns=this.numTurns+1,a>0||0!==nextToMove}}convertCanvasToImage(e){var a=new Image;return a.src=e.toDataURL("image/png"),a}}darworms$1.main=function(){function e(e){function a(){e.resume().then(t)}function t(){events.forEach(e=>b.removeEventListener(e,a))}if("suspended"===e.state){const e=document.body,t=["touchstart","touchend","mousedown","keydown"];t.forEach(t=>e.addEventListener(t,a,!1))}}var a=function(){alert("This is a deviceInfo."),document.getElementById("width").innerHTML=screen.width,document.getElementById("height").innerHTML=screen.height,document.getElementById("colorDepth").innerHTML=screen.colorDepth},t=[3,0,1,0],r=["#p1button","#p2button","#p3button","#p4button","#p1Lbutton","#p2Lbutton","#p3Lbutton","#p4Lbutton"],s=[" None ","Random"," Same "," New  "],o=["#p1textfield","#p2textfield","#p3textfield","#p4textfield","#edittextfield"],i=[new Worm(1,darworms$1.wormStates.paused),new Worm(2,darworms$1.wormStates.paused),new Worm(3,darworms$1.wormStates.paused),new Worm(4,darworms$1.wormStates.paused)],n=function(){$("#p1button").text(s[t[0]]),$("#p2button").text(s[t[1]]),$("#p3button").text(s[t[2]]),$("#p4button").text(s[t[3]]),$("#p1Lbutton").text(s[t[0]]),$("#p2Lbutton").text(s[t[1]]),$("#p3Lbutton").text(s[t[2]]),$("#p4Lbutton").text(s[t[3]]);$("#p4button")[0];i.forEach(function(e,a){e.wType=t[a],e.typeName=s[e.wType],$(r[a]).removeClass(0===t[a]?"ui-opaque":"ui-grayed-out"),$(r[a]).addClass(0===t[a]?"ui-grayed-out":"ui-opaque")})},d=function(){if(darworms$1.theGame&&darworms$1.theGame.gameState!==darworms$1.gameStates.over)$(".darwormTypeRadioButtons").hide(),$(".playKeyNotes").hide();else{$(".darwormTypeRadioButtons").show(),$(".playKeyNotes").show();var e=t[darworms$1.selectedIdx];darworms$1.colorNames[darworms$1.selectedIdx];switch(e){case 0:$("#edit-radio-choice-1").prop("checked",!0).checkboxradio("refresh");break;case 1:$("#edit-radio-choice-2").prop("checked",!0).checkboxradio("refresh");break;case 2:$("#edit-radio-choice-3").prop("checked",!0).checkboxradio("refresh");break;case 3:$("#edit-radio-choice-4").prop("checked",!0).checkboxradio("refresh")}$("input[name=edit-radio-choice]").checkboxradio("refresh"),$("input[name='edit-textname']").textinput({theme:darworms$1.themes[darworms$1.selectedIdx]}),$(o[4]).val(0==t[darworms$1.selectedIdx]?"":i[darworms$1.selectedIdx].name)}},m=function(){n()},w=function(){darworms$1.theGame&&darworms$1.theGame.gameState!==darworms$1.gameStates.over?($("#geometryradios").hide(),$("#gridsizeslider").hide(),$("#abortgame").show()):($("#geometryradios").show(),$("#gridsizeslider").show(),$("#abortgame").hide()),$("#fps").val(darworms$1.graphics.fps).slider("refresh"),$("#gridsize").val(darworms$1.dwsettings.gridSize).slider("refresh"),$("#backg").val(darworms$1.dwsettings.backGroundTheme).slider("refresh"),$("#doanim").val(darworms$1.dwsettings.doAnimations).slider("refresh"),$("#audioon").val(darworms$1.dwsettings.doAudio).slider("refresh"),$("#fixedinitpos").val(darworms$1.dwsettings.fixedInitPos).slider("refresh"),$("#pickDirectionUI").val(darworms$1.dwsettings.pickDirectionUI).slider("refresh")},c=function(){darworms$1.dwsettings.gridGeometry=$("input[name=geometry-radio-choice]:checked").val(),darworms$1.dwsettings.backGroundTheme!==$("#backg").slider().val()&&(darworms$1.dwsettings.backGroundTheme=$("#backg").slider().val(),darworms$1.theGame&&(clearCanvas(),drawCells())),darworms$1.dwsettings.gridSize=parseInt($("#gridsize").val()),darworms$1.dwsettings.doAnimations="true"==$("#doanim").slider().val(),darworms$1.dwsettings.doAudio="1"==$("#audioon").slider().val()?1:0,darworms$1.dwsettings.fixedInitPos="1"==$("#fixedinitpos").slider().val()?1:0,darworms$1.dwsettings.pickDirectionUI="1"==$("#pickDirectionUI").slider().val()?1:0,log(" darworms.dwsettings.doAnimations "+darworms$1.dwsettings.doAnimations),log(" darworms.dwsettings.doAudio "+darworms$1.dwsettings.doAudio),darworms$1.dwsettings.masterAudioVolume=$("#audiovol").val()/100,darworms$1.graphics.fps=parseInt($("#fps").val()),darworms$1.graphics.frameInterval=1e3/darworms$1.graphics.fps,log(" darworms.dwsettings.masterAudioVolume "+darworms$1.dwsettings.masterAudioVolume)},h=function(e){var a=JSON.parse(e);darworms$1.dwsettings.gridGeometry=a.gridGeometry,darworms$1.dwsettings.backGroundTheme!==a.backGroundTheme&&(darworms$1.dwsettings.backGroundTheme=a.backGroundTheme,darworms$1.theGame&&(clearCanvas(),drawCells())),darworms$1.dwsettings.doAnimations=a.doAnimations,darworms$1.dwsettings.doAudio=a.doAudio,darworms$1.dwsettings.fixedInitPos=a.fixedInitPos,darworms$1.dwsettings.pickDirectionUI=a.pickDirectionUI,darworms$1.dwsettings.masterAudioVolume=a.masterAudioVolume,darworms$1.graphics.fps=a.fps,darworms$1.graphics.frameInterval=1e3/darworms$1.graphics.fps,darworms$1.dwsettings.gridSize=a.width;var r=/^[ABCDEF\?]{63}X$/;return a.players.forEach(function(e){var a=e.index;i[a].name=e.name,r.test(i[a].name)&&(i[a].fromText(i[a].name)||(alert("Invalid DNA for Daworm # "+(a+1)+" "),i[a].wType=0)),i[a].wType=" None "==e.typeName?0:2,t[a]=i[a].wType,i[a].score=e.score,i[a].instrument=e.instrument,i[a].setNotes(e.instrument),i[a].musickeyName=e.musickeyName,i[a].MusicScale=e.MusicScale}),a},l=function(){log(" pagebeforeshow setupGridGeometry "),darworms$1.theGame&&darworms$1.theGame.gameState!==darworms$1.gameStates.over?$("#geometryradios").hide():$("#geometryradios").show();var e=darworms$1.dwsettings.gridGeometry;switch(e){case"torus":$("#geometry-radio-torus").prop("checked",!0).checkboxradio("refresh");break;case"falloff":$("#geometry-radio-falloff").prop("checked",!0).checkboxradio("refresh");break;case"reflect":$("#geometry-radio-reflect").prop("checked",!0).checkboxradio("refresh");break;default:alert(" unknown grid geometry requested: "+e)}},g=function(e){var a={x:0,y:0};if("touchstart"==e.type||"touchmove"==e.type||"touchend"==e.type||"touchcancel"==e.type){var t=e.originalEvent.touches[0]||e.originalEvent.changedTouches[0];a.x=t.pageX,a.y=t.pageY}else"mousedown"==e.type||"mouseup"==e.type||"mousemove"==e.type||"mouseover"==e.type||"mouseout"==e.type||"mouseenter"==e.type||"mouseleave"==e.type?(a.x=e.pageX,a.y=e.pageY):"tap"==e.type&&(a.x=(e.clientX||e.changedTouches[0].pageX)-e.currentTarget.offsetLeft,a.y=(e.clientY||e.changedTouches[0].pageY)-e.currentTarget.offsetTop);return a},u=function(e){var a=g(e),t=a.x,r=a.y;log(" Tap Event at x: "+t+" y: "+r),darworms$1.theGame.gameState===darworms$1.gameStates.waiting&&selectDirection(new Point(t,r))};darworms$1.menuButton=function(){log(" menuButton"),!darworms$1.theGame.gameState||darworms$1.theGame.gameState!=darworms$1.gameStates.running&&darworms$1.theGame.gameState!=darworms$1.gameStates.paused?darworms$1.theGame.gameState==darworms$1.gameStates.waiting?$.mobile.changePage("#settingspage"):$.mobile.changePage("#menupage"):(darworms$1.theGame.gameState=darworms$1.gameStates.paused,$.mobile.changePage("#settingspage"),darworms$1.theGame.needsRedraw=!0,drawCells(),$("#startpause").text("Resume Game"))},darworms$1.setKeyVal=function(e){var a=$("#select-native-key");1==a.length&&i[darworms$1.selectedIdx].setKey(a.val())},darworms$1.setInstrumentVal=function(e){var a=$("#select-native-edit");if(1==a.length){var t=parseInt(a.val());i[darworms$1.selectedIdx].setNotes(t)}},darworms$1.sendemail=function(){log(" sendEMail "+darworms$1.gameTxt),emailGame(darworms$1.gameTxt)},darworms$1.saveGame=function(){log(" saveGame "),saveGame(darworms$1.gameTxt)},darworms$1.startgame=function(e){log(" Startgame start now = "+e),darworms$1.theGame&&log("GameState is "+darworms$1.theGame.gameState+darworms$1.gameStateNames[darworms$1.theGame.gameState]),darworms$1.dwsettings.isLargeScreen=wCanvas.width>=darworms$1.dwsettings.minLargeWidth;var a=new Point(wCanvas.width,wCanvas.height);if(darworms$1.wCanvasPixelDim=a,void 0!==darworms$1.theGame&&null!==darworms$1.theGame&&darworms$1.theGame.grid.height==darworms$1.dwsettings.gridSize&&darworms$1.wCanvasPixelDim.isEqualTo(a)||(log(" theGame size has changed Screen is"+a.format()+" grid = "+darworms$1.dwsettings.gridSize+" x "+darworms$1.dwsettings.gridSize),0!=(1&darworms$1.dwsettings.gridSize)&&(darworms$1.dwsettings.gridSize=darworms$1.dwsettings.gridSize+1),1===$("#debug").slider().val()&&alert(" wCanvas "+wCanvas.width+" x "+wCanvas.height+" css "+$("#wcanvas").width()+" x "+$("#wcanvas").height()+" window "+window.innerWidth+" x "+window.innerHeight),darworms$1.theGame=new Game(darworms$1.dwsettings.gridSize,darworms$1.dwsettings.gridSize)),darworms$1.theGame.gameState===darworms$1.gameStates.over&&(darworms$1.theGame.initGame(),$("#startpause").text("Start Game"),darworms$1.theGame.needsRedraw=!0,drawCells(),darworms$1.theGame.worms=i,log(" init gridsize: "+$("#gridsize").val()+" gHeight"+darworms$1.dwsettings.gridSize),i.forEach(function(e,a){e.init(t[a]),0!==t[a]?$(r[a]).addClass("ui-opaque"):$(r[a]).addClass("ui-grayed-out");var s=1==darworms$1.dwsettings.fixedInitPos?darworms$1.theGame.origin:2==t[a]?e.startingPos:new Point(Math.floor(Math.random()*darworms$1.theGame.grid.width),Math.floor(Math.random()*darworms$1.theGame.grid.height));e.place(darworms$1.initialWormStates[t[a]],darworms$1.theGame,s),0!==t[a]&&darworms$1.theGame.grid.setSinkAt(s)})),n(),!1!==e){if(updateScores(i),log(" NEW in startgame darworms.dwsettings.doAnimations "+darworms$1.dwsettings.doAnimations),darworms$1.theGame.gameState===darworms$1.gameStates.running)return $("#startpause").text("Resume Game"),darworms$1.theGame.gameState=darworms$1.gameStates.paused,darworms$1.theGame.needsRedraw=!0,void drawCells();if(darworms$1.theGame.gameState===darworms$1.gameStates.paused)return $("#startpause").text("Pause"),void(darworms$1.theGame.gameState=darworms$1.gameStates.running);if(darworms$1.theGame.gameState===darworms$1.gameStates.over){darworms$1.theGame.gameState=darworms$1.gameStates.running;var s=darworms$1.dwsettings.doAnimations?darworms$1.graphics.fps:60;p(s),log(" setInterval: "+1e3/$("#fps").val()),$("#startpause").text("Pause Game"),v(!0),darworms$1.theGame.log()}darworms$1.dwsettings.doAnimations||(log('darworms.dwsettings.doAnimations == "false"'),darworms$1.theGame.gameState=darworms$1.gameStates.running,clearCanvas(),drawCells(),log(" Game Running"),$("#startpause").text("Running"))}};var p=function(e){darworms$1.graphics.fps=e,darworms$1.graphics.frameInterval=1e3/e,darworms$1.graphics.iufps=30,darworms$1.graphics.uiInterval=1e3/e,darworms$1.graphics.animFrame=0,darworms$1.graphics.uiFrames=0,darworms$1.graphics.rawFrameCount=0,darworms$1.graphics.drawFrameCount=0,darworms$1.graphics.rawFrameCount=0,darworms$1.graphics.uiFrameCount=0,darworms$1.graphics.then=Date.now(),darworms$1.graphics.uiThen=Date.now(),darworms$1.graphics.startTime=darworms$1.graphics.then,darworms$1.graphics.uiInterval=1e3/darworms$1.graphics.uifps,f()},f=function(){if(darworms$1.graphics.rawFrameCount++,darworms$1.theGame.gameState==darworms$1.gameStates.over){i.forEach(function(e,a){3==e.wType&&(e.wType=2),e.toText()});for(let e=0;e<4;e++)t[e]=i[e].wType;return void n()}if(requestAnimationFrame(f),darworms$1.graphics.animFrame=darworms$1.graphics.animFrame+1,darworms$1.theGame.gameState===darworms$1.gameStates.running)if(darworms$1.graphics.now=Date.now(),darworms$1.dwsettings.doAnimations)darworms$1.graphics.elapsed=darworms$1.graphics.now-darworms$1.graphics.then,darworms$1.graphics.elapsed>darworms$1.graphics.frameInterval&&(darworms$1.graphics.uiFrames=darworms$1.graphics.uiFrames+1,makeMoves(),darworms$1.graphics.then=darworms$1.graphics.now-darworms$1.graphics.elapsed%darworms$1.graphics.frameInterval);else{for(var e=Date.now(),a=0;a<80&&darworms$1.theGame.gameState!=darworms$1.gameStates.over&&darworms$1.theGame.gameState!==darworms$1.gameStates.waiting;)a+=1,makeMoves();log("Compute time: "+(Date.now()-e));e=Date.now();updateScores(darworms$1.theGame.worms),drawDirtyCells(),log("Draw time: "+(Date.now()-e)),log(".")}darworms$1.theGame.gameState===darworms$1.gameStates.waiting&&(darworms$1.graphics.now=Date.now(),darworms$1.graphics.uiElapsed=darworms$1.graphics.now-darworms$1.graphics.uiThen,darworms$1.graphics.uiElapsed>darworms$1.graphics.uiInterval&&(drawPickCells(),darworms$1.graphics.uiThen=darworms$1.graphics.now-darworms$1.graphics.uiElapsed%darworms$1.graphics.uiInterval))};darworms$1.abortgame=function(){log("Abort Game called"),$.mobile.changePage("#abortdialog","pop",!0,!0)},darworms$1.emailDarwormButton=function(e){log("emailDarwormButton called"),i[darworms$1.selectedIdx].emailDarworm()},darworms$1.playScale=function(e){log("playScale called"),i[darworms$1.selectedIdx].playScale()},darworms$1.yesabortgame=function(){log("Abort Game called"),$.mobile.changePage("#playpage"),darworms$1.theGame.gameState=darworms$1.gameStates.over,darworms$1.startgame(!1)},darworms$1.noabortgame=function(){log("Abort Game called"),$.mobile.changePage("#settingspage")};var v=function(e){darworms$1.theGame.gameState=e?darworms$1.gameStates.running:darworms$1.gameStates.over,darworms$1.theGame.needsRedraw=!0},x=function(e,a){e.removeClass("ui-page-theme-c"),e.removeClass("ui-page-theme-d"),e.removeClass("ui-page-theme-e"),e.removeClass("ui-page-theme-f"),e.page("option","theme",a)},G=function(e){log(" initEditPage "+darworms$1.selectedIdx),x($("#edit-darworm-page"),darworms$1.themes[darworms$1.selectedIdx]),$("#edittextfield").val(0==i[darworms$1.selectedIdx].wType?"":i[darworms$1.selectedIdx].name),$("[name=select-instrument]").val(i[darworms$1.selectedIdx].instrument),$("[name=select-instrument]").selectmenu("refresh"),$("[name=select-key]").val(i[darworms$1.selectedIdx].musickeyName),$("[name=select-key]").selectmenu("refresh"),$("#edit-darworm-page").trigger("create")},S=function(){darworms$1.audioContext=new(window.AudioContext||window.webkitAudioContext),null==darworms$1.audioContext&&(darworms$1.dwsettings.doAudio=!1,alert(" Could not load webAudio... muting game"),$("#doAudio").hide()),e(darworms$1.audioContext),log("audio is "+darworms$1.dwsettings.doAudio+"  Context state is "+darworms$1.audioContext.state),darworms$1.dwsettings.doAudio&&(void 0!==darworms$1.audioContext.createGain&&(darworms$1.masterGainNode=darworms$1.audioContext.createGain(.5)),void 0!==darworms$1.audioContext.createStereoPanner&&(darworms$1.audioPanner=darworms$1.audioContext.createStereoPanner()),new AudioSample("piano","sounds/piano-c2.wav"),new AudioSample("guitar","sounds/GuitarTrimmed.wav"),new AudioSample("kalimba","sounds/i_kalimba_c5.wav"),new AudioSample("sitar","sounds/Sitar-C5.wav"),new AudioSample("flute","sounds/FluteC3Trimmed.wav"),new AudioSample("clarinet","sounds/ClarinetTrimmed.wav"),new AudioSample("death","sounds/darworm-death.wav"));var a=.5;do{darworms$1.audioPlaybackRates.push(a),darworms$1.audioFrequencies.push(261.626*a),a*=1.05946309436}while(darworms$1.audioPlaybackRates.length<13);if(log("Final rate = "+darworms$1.audioPlaybackRates[12]+"  error: "+(1-darworms$1.audioPlaybackRates[12])),darworms$1.audioPlaybackRates[12]=1,"suspended"===darworms$1.audioContext.state){var t=function(){darworms$1.audioContext.resume(),setTimeout(function(){"running"===darworms$1.audioContext.state&&document.body.removeEventListener("touchend",t,!1)},0)};document.body.addEventListener("touchend",t,!1)}},y=function(e){switch(e){case"none":return 0;case"random":return 1;case"same":return 2;case"new":return 3;default:return alert("unknown type (not none, randowm, new or same)"),0}};return{init:function(){document.addEventListener("deviceready",a,!0),$("#logging").slider().val(darworms$1.dwsettings.dologging?"true":"false"),$("#versionstring")[0].innerHTML="Version "+darworms$1.version;try{const e=new URLSearchParams(window.location.search);log(location.search),e.has("darwormsgame")&&(darworms$1.gameTxt=decodeURIComponent(e.get("darwormsgame")),darworms$1.gameTxt&&(h(darworms$1.gameTxt),scoreCanvasInit(),updateScores(i),$.mobile.changePage("#playpage"),darworms$1.dwsettings.forceInitialGridSize=!1))}catch(e){alert("Trouble parsing the url. Be sure to copy and paste the entire url starting with 'https' all way through to the lst '}' \n"+e.message)}graphicsInit(),darworms$1.dwsettings.isLargeScreen=$(window).width()>=darworms$1.dwsettings.minLargeWidth,darworms$1.dwsettings.forceInitialGridSize&&(darworms$1.dwsettings.gridSize=darworms$1.dwsettings.isLargeScreen?darworms$1.dwsettings.largeGridSize:darworms$1.dwsettings.smallGridSize),darworms$1.wCanvasPixelDim=new Point(wCanvas.clientWidth,wCanvas.clientHeight),$("#wcanvas").bind("tap",u),$("#pickDirectionUI").slider().val(0),$("#pickDirectionUI").slider("refresh"),darworms$1.wCanvasRef=$("#wcanvas"),S(),n(),gameInit(),darworms$1.dwsettings.noWhere=new Point(-1,-1),!window.location.hash&&window.addEventListener&&(window.addEventListener("load",function(){log("load event listener triggered"),setTimeout(function(){window.scrollTo(0,0)},100)}),window.addEventListener("orientationchange",function(){setTimeout(function(){window.scrollTo(0,0)},100)})),$(window).bind("throttledresize orientationchange",function(e){window.scrollTo(1,0),log("resize event triggered"),darworms$1.theGame&&clearCanvas(),resizeCanvas(),darworms$1.theGame&&reScale(darworms$1.theGame.grid.width,darworms$1.theGame.grid.height)}),i.forEach(function(e,a){e.setNotes(e.instrument||0)}),resizeCanvas(),$("#p1button").click(function(){darworms$1.selectedIdx=0}),$("#p2button").click(function(){darworms$1.selectedIdx=1}),$("#p3button").click(function(){darworms$1.selectedIdx=2}),$("#p4button").click(function(){darworms$1.selectedIdx=3}),$("#nextbutton").click(function(){log(" nextbutton clicked"),$.mobile.changePage("#edit-darworm-page",{allowSamePageTransition:!0}),darworms$1.selectedIdx=(darworms$1.selectedIdx+1)%i.length,G(darworms$1.selectedIdx)}),$("input[name='edit-radio-choice']").on("change",function(){log(" edit-radio-choice on change function");var e=$("input[name='edit-radio-choice']:checked").val();t[darworms$1.selectedIdx]=y(e),i[darworms$1.selectedIdx].init(y(e)),$("#edittextfield").val(0==y(e)?"":i[darworms$1.selectedIdx].name)}),$("input[name='edit-textname']").on("change",function(){log(" edit-textname");var e=$("input[name='edit-textname']").val();/^[ABCDEF\?]{63}X$/.test(e)?i[darworms$1.selectedIdx].fromText(e)&&(i[darworms$1.selectedIdx].wType=2,t[darworms$1.selectedIdx]=2,d(),$(darworms$1.buttonSelectors[darworms$1.selectedIdx]).text(s[t[darworms$1.selectedIdx]]),$(darworms$1.buttonLSelectors[darworms$1.selectedIdx]).text(s[t[darworms$1.selectedIdx]]),i[darworms$1.selectedIdx].toText(),$("input[name='edit-textname']").textinput({theme:darworms$1.themes[darworms$1.selectedIdx]})):$("input[name='edit-textname']").textinput({theme:"a"})})},gWorms:i,setSelectedDarwormType:m,setupEditPage:d,applySettings:c,injectSettings:h,showSettings:w,setupGridGeometry:l,initPlayPage:function(){$("#myPages").css({overflow:"hidden",height:"100%"}),$("#wcanvasparagrap").css({background:darworms$1.dwsettings.cellBackground[darworms$1.dwsettings.backGroundTheme]}),void 0!==darworms$1.theGame&&null!==darworms$1.theGame&&darworms$1.theGame.grid.height==darworms$1.dwsettings.gridSize||(darworms$1.theGame=new Game(darworms$1.dwsettings.gridSize,darworms$1.dwsettings.gridSize),setGrid(darworms$1.theGame.grid,darworms$1.theGame)),n(),drawCells(),updateScores(darworms$1.main.gWorms),darworms$1.playpageInitialized||(resizeCanvas(),darworms$1.startgame(!1),darworms$1.audioContext.resume(),darworms$1.playpageInitialized=!0)},leavePlayPage:function(){$("#myPages").css({overflow:"auto",height:"auto"}),darworms$1.playpageInitialized||(resizeCanvas(),darworms$1.startgame(!1),darworms$1.audioContext.resume(),darworms$1.playpageInitialized=!0),$("body").css("scroll","on"),$("body").css("overflow","hidden")},wormEventHandler:u,initEditPage:G,leaveEditPage:function(e){log(" leaveEditPage "+e)},loadSavedGames:function(){log(" loadSavedGames "),loadGames()},freeSavedGames:function(){log(" freeSavedGames "),freeGames()}}}();
//# sourceMappingURL=bundle.js.map
