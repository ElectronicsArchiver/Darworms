function log(e){"true"==$("#logging").slider().val()&&console.log(e)}function logging(){return"true"==$("#logging").slider().val()}function numOneBits(e){for(var t=0;e>0;)t+=1&e,e>>=1;return t}function getOrCreateMethodChain(e,t){let s=instances.filter(s=>s.context==e&&s.methodName==t)[0];return s||(s=new MethodChain(e,t),instances.push(s)),s}function createFieldsObj(e,t,s,a,r,o){if("function"==typeof a){const i=s.get("buildHitTask");return{buildHitTask:s=>{s.set(e,null,!0);s.set(t,null,!0);a(s,r,o);i(s)}}}return assign({},e,t)}function capitalize(e){return e.charAt(0).toUpperCase()+e.slice(1)}function provide(e,t){const s=window.GoogleAnalyticsObject||"ga";window[s]=window[s]||function(...e){(window[s].q=window[s].q||[]).push(e)},window.gaDevIds=window.gaDevIds||[],window.gaDevIds.indexOf(DEV_ID)<0&&window.gaDevIds.push(DEV_ID),window[s]("provide",e,t),window.gaplugins=window.gaplugins||{},window.gaplugins[capitalize(e)]=t}function trackUsage(e,t){trackVersion(e),trackPlugin(e,t)}function convertHexToBin(e){return parseInt(e||"0",16).toString(2)}function convertBinToHex(e){return parseInt(e||"0",2).toString(16)}function padZeros(e,t){if(e.length<t){let s=t-e.length;for(;s;)e="0"+e,s--}return e}function flipBitOn(e,t){return e.substr(0,t)+1+e.substr(t+1)}function trackPlugin(e,t){let s=padZeros(convertHexToBin(e.get("&"+USAGE_PARAM)),PLUGIN_COUNT);s=flipBitOn(s,PLUGIN_COUNT-t),e.set("&"+USAGE_PARAM,convertBinToHex(s))}function trackVersion(e){e.set("&"+VERSION_PARAM,VERSION)}function getPath(){return location.pathname+location.search}function AudioSample(e,t){this.location=t,this.name=e,this.incomingbuffer=void 0,this.savedBuffer=void 0;var s=new XMLHttpRequest;s.open("get",t,!0),s.responseType="arraybuffer",s.onload=function(){darworms$1.audioContext.decodeAudioData(s.response,function(e){this.savedBuffer=e}.bind(this))}.bind(this),s.send(),darworms$1.audioSamples.push(this)}function drawdna(e,t,s){let a=e.clientWidth,r=e.clientHeight;(pGraphics=e.getContext("2d")).setTransform(1.5*a/2,0,0,.75*r/2,1.5*a/2,.75*r/2),pGraphics.fillStyle=darworms$1.dwsettings.cellBackground[darworms$1.dwsettings.backGroundTheme],pGraphics.strokeStyle="black",pGraphics.lineWidth=.02,pGraphics.rect(-1,-1,2,2),pGraphics.fill(),pGraphics.beginPath(),pGraphics.moveTo(xPts[0],yPts[0]);for(o=1;o<6;o+=1)pGraphics.lineTo(xPts[o],yPts[o]);pGraphics.lineTo(xPts[0],yPts[0]),pGraphics.stroke();for(var o=0,i=1;o<6;o++,i<<=1)pGraphics.setLineDash(0==(s&i)?[.02,.02]:[]),pGraphics.lineWidth=0==(s&i)?.01:.04,pGraphics.beginPath(),pGraphics.moveTo(0,0),pGraphics.lineTo(xPts[o],yPts[o]),pGraphics.stroke();pGraphics.setLineDash([])}function graphicsInit(e){wCanvas=document.getElementById("wcanvas"),wGraphics=wCanvas.getContext("2d"),resizeCanvas()}function setGrid(e,t){grid=e,timeInDraw=0,frameTimes.length=0,startFrameTimes.length=0,theGame=t}function setScale(e,t){scale=new Point(wCanvas.width/(e+1.5),wCanvas.height/(t+1))}function reScale(e,t){setScale(e,t),logging()&&console.log(" reScaled to "+scale.format())}function clearCanvas(){wGraphics.save(),wGraphics.setTransform(1,0,0,1,0,0),wGraphics.clearRect(0,0,wCanvas.width,wCanvas.height),wGraphics.fillStyle=darworms$1.dwsettings.cellBackground[darworms$1.dwsettings.backGroundTheme],wGraphics.fillStyle="#F5F5F500",wGraphics.fillRect(0,0,wCanvas.width,wCanvas.height),wGraphics.restore()}function startGameTimer(){gameElapsedTime=-(new Date).getTime()}function stopGameTimer(){gameElapsedTime+=(new Date).getTime()}function getOffset(e){var t,s;return t=0==(1&e.y)?(e.x+.5)*scale.x+scale.x/2:(e.x+1)*scale.x+scale.x/2,s=(e.y+.5)*scale.y+scale.y/2,new Point(t,s)}function gsetTranslate(e){var t=getOffset(e);wGraphics.setTransform(scale.x,0,0,scale.y,t.x,t.y)}function drawCells(){if(grid){wGraphics.save();for(var e=0;e<grid.width;e+=1)for(var t=0;t<grid.height;t+=1)drawcell(new Point(e,t));wGraphics.restore()}}function drawcell(e){timeInDraw-=Date.now(),gsetTranslate(e);var t=grid.spokeAt(e,7);wGraphics.lineWidth=2/scale.x,wGraphics.strokeStyle=darworms$1.dwsettings.colorTable[15&t],wGraphics.fillStyle=darworms$1.dwsettings.cellBackground[darworms$1.dwsettings.backGroundTheme],wGraphics.beginPath(),wGraphics.moveTo(darworms$1.graphics.vertex_x[0],darworms$1.graphics.vertex_y[0]);for(s=1;s<6;s+=1)wGraphics.lineTo(darworms$1.graphics.vertex_x[s],darworms$1.graphics.vertex_y[s]);if(wGraphics.stroke(),wGraphics.closePath(),wGraphics.fill(),t){wGraphics.strokeStyle=darworms$1.dwsettings.colorTable[15&t],wGraphics.fillStyle=darworms$1.dwsettings.alphaColorTable[15&t],wGraphics.beginPath(),wGraphics.moveTo(darworms$1.graphics.vertex_x[0],darworms$1.graphics.vertex_y[0]);for(s=1;s<6;s+=1)wGraphics.lineTo(darworms$1.graphics.vertex_x[s],darworms$1.graphics.vertex_y[s]);wGraphics.stroke(),wGraphics.closePath(),wGraphics.fill()}wGraphics.fillStyle=darworms$1.dwsettings.alphaColorTable[15&grid.spokeAt(e,6)],wGraphics.lineWidth=2/scale.x,wGraphics.beginPath(),wGraphics.arc(0,0,.1,0,2*Math.PI,!0),wGraphics.closePath(),wGraphics.fill(),wGraphics.strokeStyle=darworms$1.dwsettings.cellBackground[1-darworms$1.dwsettings.backGroundTheme],wGraphics.lineWidth=1/scale.x,wGraphics.beginPath(),wGraphics.moveTo(darworms$1.graphics.vertex_x[0],darworms$1.graphics.vertex_y[0]);for(var s=1;s<6;s+=1)wGraphics.lineTo(darworms$1.graphics.vertex_x[s],darworms$1.graphics.vertex_y[s]);wGraphics.lineTo(darworms$1.graphics.vertex_x[0],darworms$1.graphics.vertex_y[0]),wGraphics.stroke(),wGraphics.closePath();for(var a=grid.outVectorsAt(e),r=grid.inVectorsAt(e),o=0;o<6;o+=1){if(0!=(a&darworms$1.outMask[o])){var i=darworms$1.dwsettings.colorTable[grid.spokeAt(e,o)];wGraphics.strokeStyle=i,wGraphics.lineWidth=2/scale.x,wGraphics.lineCap="round",wGraphics.beginPath(),wGraphics.moveTo(0,0),wGraphics.lineTo(xPts$1[o],yPts$1[o]),wGraphics.stroke(),wGraphics.closePath()}0!=(r&darworms$1.outMask[o])&&(wGraphics.strokeStyle=darworms$1.dwsettings.colorTable[grid.spokeAt(e,o)],wGraphics.lineWidth=2/scale.x,wGraphics.lineCap="round",wGraphics.beginPath(),wGraphics.moveTo(xPts$1[o],yPts$1[o]),wGraphics.lineTo(0,0),wGraphics.stroke(),wGraphics.closePath())}if(grid.isSink(e)){wGraphics.strokeStyle=darworms$1.dwsettings.colorTable[0];for(var n=0;n<3;n+=1){var d=(n+3)%6;wGraphics.beginPath(),wGraphics.moveTo(xPts$1[n]*asterixSize,yPts$1[n]*asterixSize),wGraphics.lineTo(xPts$1[d]*asterixSize,yPts$1[d]*asterixSize),wGraphics.stroke(),wGraphics.closePath(),wGraphics.lineTo(darworms$1.graphics.vertex_x[s],darworms$1.graphics.vertex_y[s])}}timeInDraw+=Date.now()}function drawDirtyCells(){for(var e;void 0!==(e=dirtyCells.pop());)drawcell(e)}function pushDirtyCell(e){dirtyCells.push(e)}function highlightWorm(e,t){e.state===darworms$1.gameStates.waiting&&(gsetTranslate(e.pos),wGraphics.fillStyle=darworms$1.dwsettings.cellBackground[darworms$1.dwsettings.backGroundTheme],wGraphics.beginPath(),wGraphics.arc(0,0,.2,0,2*Math.PI,!0),wGraphics.closePath(),wGraphics.fill(),wGraphics.fillStyle=darworms$1.dwsettings.alphaColorTable[e.colorIndex],wGraphics.beginPath(),wGraphics.arc(0,0,(31&darworms$1.graphics.animFrame)/31*.2,0,2*Math.PI,!0),wGraphics.closePath(),wGraphics.fill())}function initPickUI(e){logging()&&console.log(" initPickUI"),darworms$1.pickCells=new Array;for(var t=this.grid.outVectorsAt(e.pos),s=this.grid.inVectorsAt(e.pos),a=0;a<6;a+=1)if(0==(t&darworms$1.outMask[a])&&0==(s&darworms$1.outMask[a])){var r={};r.pos=this.grid.next(e.pos,a),r.dir=a,r.color=darworms$1.dwsettings.alphaColorTable[theGame.focusWorm.colorIndex],r.wormColorIndex=theGame.focusWorm.colorIndex,darworms$1.pickCells.push(r)}}function drawPickCells(){var e=1*(127&darworms$1.graphics.animFrame)/128;1==darworms$1.dwsettings.pickDirectionUI&&e<.1&&(clearCanvas(),drawCells()),darworms$1.pickCells.forEach(function(e){drawPickCell(e.pos,e.color)}),drawPickCellOrigin(darworms$1.theGame.focusWorm.pos,darworms$1.dwsettings.alphaColorTable[darworms$1.theGame.focusWorm.colorIndex]),1==darworms$1.dwsettings.pickDirectionUI&&darworms$1.pickCells.forEach(function(e){drawExpandedTarget(e)}),darworms$1.theGame.worms.forEach(function(e,t){highlightWorm(e,t)},darworms$1.theGame)}function drawPickCell(e,t){gsetTranslate(e),wGraphics.fillStyle=darworms$1.dwsettings.cellBackground[darworms$1.dwsettings.backGroundTheme],0!==this.grid.spokeAt(e,7)&&logging()&&console.log(" Why is an owned cell a target selection? "+e.format(e)),drawcell(e);var s=1*(63&darworms$1.graphics.animFrame)/64;wGraphics.strokeStyle=t,wGraphics.fillStyle=t,wGraphics.beginPath(),wGraphics.moveTo(darworms$1.graphics.vertex_x[0]*s,darworms$1.graphics.vertex_y[0]*s);for(var a=1;a<6;a+=1)wGraphics.lineTo(darworms$1.graphics.vertex_x[a]*s,darworms$1.graphics.vertex_y[a]*s);wGraphics.moveTo(darworms$1.graphics.vertex_x[0],darworms$1.graphics.vertex_y[0]),wGraphics.stroke(),wGraphics.closePath(),wGraphics.fill(),wGraphics.fillStyle=darworms$1.dwsettings.alphaColorTable[15&this.grid.spokeAt(e,6)]}function drawPickCellOrigin(e,t){gsetTranslate(e),wGraphics.fillStyle=darworms$1.dwsettings.cellBackground[darworms$1.dwsettings.backGroundTheme],0!==this.grid.spokeAt(e,7)&&logging()&&console.log(" Why is an owned cell a target selection origin? "+e.format(e)),drawcell(e);var s=1*(63&darworms$1.graphics.animFrame)/64;wGraphics.strokeStyle=t,wGraphics.fillStyle=t;for(var a=this.grid.outVectorsAt(e),r=this.grid.inVectorsAt(e),o=0;o<6;o+=1)0==(a&darworms$1.outMask[o])&&0==(r&darworms$1.outMask[o])&&(wGraphics.lineWidth=3/scale.x,wGraphics.lineCap="round",wGraphics.beginPath(),wGraphics.moveTo(0,0),wGraphics.lineTo(xPts$1[o]*s,yPts$1[o]*s),wGraphics.stroke(),wGraphics.closePath())}function drawExpandedTarget(e){var t=getOffset(e.pos);wGraphics.save();const s=darworms$1.dwsettings.alphaColorTable[e.wormColorIndex];wGraphics.strokeStyle=s,wGraphics.lineWidth=4,wGraphics.setTransform(1,0,0,1,0,0),wGraphics.beginPath();var a=xPts$1[e.dir]*wCanvas.width*.75/2+wCanvas.width/2,r=yPts$1[e.dir]*wCanvas.height*.75/2+wCanvas.height/2;wGraphics.arc(a,r,20,0,2*Math.PI,!1),wGraphics.closePath(),wGraphics.stroke(),wGraphics.strokeStyle=s,wGraphics.lineWidth=2,wGraphics.moveTo(a,r),wGraphics.beginPath(),wGraphics.moveTo(a,r);var o=1*(127&darworms$1.graphics.animFrame)/128;wGraphics.lineTo(a+(t.x-a)*o,r+(t.y-r)*o),wGraphics.closePath(),wGraphics.stroke(),wGraphics.restore()}function selectDirection(e){1==darworms$1.dwsettings.pickDirectionUI?selectLargeUIDirection(e):selectSmallUIDirection(e)}function selectSmallUIDirection(e){darworms$1.pickCells.forEach(function(t){var s=getOffset(t.pos),a=e.absDiff(s),r=new Point(e.x-s.x,e.y-s.y);a.x<scale.x/2&&a.y<scale.y/2&&this.gameState===darworms$1.gameStates.waiting&&(logging()&&console.log(" target hit delta: "+r.format()),setDNAandResumeGame(t.dir))},darworms$1.theGame)}function setDNAandResumeGame(e){theGame.focusWorm.dna[63&theGame.focusValue]=e,theGame.focusWorm.numChoices+=1,darworms$1.theGame.gameState=darworms$1.gameStates.running,clearCanvas(),drawCells()}function selectLargeUIDirection(e){for(var t,s=darworms$1.theGame.grid.stateAt(theGame.focusWorm.pos),a=1e5,r=-1,o=0;o<6;o+=1)if(0==(s&darworms$1.outMask[o])){const s=new Point(darworms$1.theGame.xPts[o]*wCanvas.width*.75/2+wCanvas.width/2,darworms$1.theGame.yPts[o]*wCanvas.height*.75/2+wCanvas.height/2);(t=s.dist(e))<a&&(a=t,r=o)}a<wCanvas.width/8&&r>=0&&setDNAandResumeGame(r)}function animateDyingWorms(){for(var e=0;e<4;e+=1){var t=e+darworms$1.graphics.uiFrames&3;theGame.worms[t].state==darworms$1.wormStates.dying&&animateDyingCell(theGame.worms[t])}}function animateDyingCell(e){drawcell(e.pos),drawShrikingOutline(e)}function drawShrikingOutline(e){var t=(darworms$1.graphics.dyningAnimationFrames-(darworms$1.graphics.uiFrames-e.diedAtFrame))/darworms$1.graphics.dyningAnimationFrames;gsetTranslate(e.pos),wGraphics.strokeStyle=darworms$1.dwsettings.alphaColorTable[e.colorIndex],wGraphics.lineWidth=.1,wGraphics.fillStyle=darworms$1.dwsettings.alphaColorTable[e.colorIndex],wGraphics.beginPath(),wGraphics.moveTo(darworms$1.graphics.vertex_x[0]*t,darworms$1.graphics.vertex_y[0]*t);for(var s=1;s<6;s+=1)wGraphics.lineTo(darworms$1.graphics.vertex_x[s]*t,darworms$1.graphics.vertex_y[s]*t);wGraphics.lineTo(darworms$1.graphics.vertex_x[0]*t,darworms$1.graphics.vertex_y[0]*t),wGraphics.closePath(),wGraphics.stroke()}function showTimes(){var e=1e8,t=0,s=0,a=0,r=0,o=0;logging()&&console.log("frameTimes.length "+frameTimes.length);for(var i=0;i<frameTimes.length;i+=1)a+=1,frameTimes[i]>t&&(t=frameTimes[i]),frameTimes[i]<e&&(e=frameTimes[i]),r+=frameTimes[i];a>0&&(s=Math.round(r/a*100)/100);var n=(new Date).getTime()-startFrameTimes[0],d=Math.round(100*r/n*100)/100;gameElapsedTime>0&&(o=Math.round(1e3*a/gameElapsedTime*100)/100),document.getElementById("wormframes").innerHTML=a,document.getElementById("wormmintime").innerHTML=e,document.getElementById("wormmaxtime").innerHTML=t,document.getElementById("wormavetime").innerHTML=s,document.getElementById("wormframetargettime").innerHTML=1e3/$("#fps").val(),document.getElementById("wormfps").innerHTML=o,e=1e6,t=0,a=0,r=0,s=0;var m=0;for(i=1;i<startFrameTimes.length;i+=1)a+=1,(m=startFrameTimes[i]-startFrameTimes[i-1])>t&&(t=m),m<e&&(e=m),r+=m;a>0&&(s=Math.round(r/a*100)/100),document.getElementById("wormframemintime").innerHTML=e,document.getElementById("wormframemaxtime").innerHTML=t,document.getElementById("wormframeavetime").innerHTML=s,document.getElementById("wormframepercenttime").innerHTML=d,document.getElementById("wormframetotaltime").innerHTML=timeInDraw/1e3}function resizeCanvas(){var e=$("#wcanvas"),t=document.getElementById("wcanvas"),s=$("#scorecanvas"),a=($("#navcontainer"),$("#footerbar"),$(window).width()),r=$(window).height();if(a/(r-140)>2&&(a=2*(r-140)),r>400)e.css({width:a-20+"px",height:r-140+"px"}),s.css({width:a-20+"px",height:"30px"});else{var o=Math.floor(.7*a);e.css({width:o+"px",height:r-110+"px"}),s.css({width:o+"px"})}t.height=r-140,t.width=a,"1"===$("#debug").slider().val()&&alert(" Resize "+a+" x "+r+" debug "+$("#debug").slider().val()),darworms$1.theGame&&(setScale(this.grid.width,this.grid.height),darworms$1.theGame.needsRedraw=!0,clearCanvas(),drawCells())}function scoreCanvasInit(e){scoreCanvas=document.getElementById("scorecanvas"),(scorectx=scoreCanvas.getContext("2d")).font="bold 18px sans-serif",scorectx.shadowColor="rgb(190, 190, 190)",scorectx.shadowOffsetX=3,scorectx.shadowOffsetY=3}function clearScore(e,t){var s=scoreCanvas.width/t;scorectx.fillStyle=darworms$1.dwsettings.cellBackground[0],scorectx.shadowOffsetX=0,scorectx.shadowOffsetY=0,scorectx.fillRect(s*e,0,s,scoreCanvas.height)}function scoreStartx(e,t,s){var a=scoreCanvas.width/t;return a*e+a/2-scorectx.measureText(s).width/2}function updateScores(e){e.forEach(function(e,t){void 0!==e&&e.shouldDrawScore()&&(clearScore(t,4),scorectx.fillStyle=darworms$1.dwsettings.colorTable[t+1],scorectx.fillText(e.score,scoreStartx(t,4,e.score.toString()),15))})}function pick(e,...t){return t.reduce((t,s)=>{e.hasOwnProperty(s)&&(t[s]=e[s]);return t},{})}function addPick(e,t,...s){return Object.assign(e,pick(t,...s))}function gameName(e){var t=new Date(e.createdAt).toString();let s=0;return e.players.forEach(function(e,t){" None "!==e.typeName&&s++}),t=t.substr(0,t.indexOf("GMT")),t+="["+e.width+"x"+e.width+": "+s,t+=1==s?" player]":" players]"}function emailGame(e){var t="mailto:?subject="+encodeURIComponent("Darworms Game ")+"&body="+encodeURIComponent("Darworms is a unique, free web strategy territoty capture game. Select everything below and paste it into a browser address bar \n\n")+encodeURIComponent(darworms.host)+encodeURIComponent("?darwormsgame=")+encodeURIComponent(e);logging()&&console.log("url: "+t),window.open(t)}function encodeGame(e,t,s,a){logging()&&console.log(" encodeGame 0 "),now=new Date,(gameObj={version:a}).createdAt=now.valueOf(),gameObj=addPick(gameObj,e,"numMoves","numTurns"),gameObj=addPick(gameObj,e.grid,"width"),gameObj=addPick(gameObj,t,"backGroundTheme","doAnimations","doAudio","gridGeometry","fixedInitPos","pickDirectionUI","masterAudioVolume"),(gameObj=addPick(gameObj,s,"fps")).players=[],e.worms.forEach(function(e,t){var s={index:t};e.toText(),s=addPick(s,e,"typeName","startingPos","name","score","instrument","musickeyName","MusicScale"),gameObj.players.push(s)}),gameTxt=JSON.stringify(gameObj),gameUrl=encodeURIComponent(gameTxt);let r=decodeURIComponent(gameUrl),o=JSON.parse(r);JSON.stringify(o);return gameTxt}function loadGames(){const e=JSON.parse(localStorage.getItem("darwormgames"));darworms.savedgames=e||[],darworms.savedgames.forEach(function(e,t){const s=JSON.parse(e),a=(new Date(s.createdAt),'<li data-icon="delete" data-split-icon="delete-black"><a class="loadMe" value='+t+">"+gameName(s)+"</a><a value="+t+' data-icon="star" data-split-icon="delete-black" class="deleteMe" ></a></li>');$("#savedgames").append(a).listview("refresh"),logging()&&console.log(" liStr: "+a)}),$(".deleteMe").on("click",function(e){logging()&&console.log(" deleteMe clicked"),logging()&&console.log($(this).attr("value"));let t=parseInt($(this).attr("value"));t>=0&&t<darworms.savedgames.length&&darworms.savedgames.splice(t,1),localStorage.setItem("darwormgames",JSON.stringify(darworms.savedgames)),refreshSavedGames()}),$(".loadMe").on("click",function(e){logging()&&console.log(" loadMe clicked"),logging()&&console.log($(this).attr("value"));let t=parseInt($(this).attr("value"));if(t>=0&&t<darworms.savedgames.length){darworms.main.injectSettings(darworms.savedgames[t]);updateScores(darworms.main.gWorms),$.mobile.changePage("#playpage")}})}function freeGames(){const e=$("#savedgames")[0];for(;e.firstChild;)e.removeChild(e.firstChild)}function saveGame(e){logging()&&console.log(" saveGame "),darworms.savedgames.push(e),localStorage.setItem("darwormgames",JSON.stringify(darworms.savedgames)),refreshSavedGames()}function refreshSavedGames(){const e=$("#savedgames")[0];for(;e.firstChild;)e.removeChild(e.firstChild);loadGames()}function makeMoves(){var e=(new Date).getTime();startFrameTimes.push(e),darworms$1.theGame.needsRedraw&&(drawCells(),darworms$1.theGame.needsRedraw=!1),darworms$1.theGame.gameState!=darworms$1.gameStates.over&&!1===darworms$1.theGame.makeMove(darworms$1.dwsettings.doAnimations)&&(stopGameTimer(),logging()&&console.log(" Game Over"),clearInterval(darworms$1.graphics.timer),$("#startpause").text("Start Game"),showTimes(),updateScores(darworms$1.theGame.worms),darworms$1.theGame.gameState=darworms$1.gameStates.over,darworms$1.gameTxt=encodeGame(darworms$1.theGame,darworms$1.dwsettings,darworms$1.graphics,darworms$1.version)),darworms$1.dwsettings.doAnimations&&(drawDirtyCells(),animateDyingWorms(),darworms$1.theGame.getAvePos()),updateScores(darworms$1.theGame.worms);var t=(new Date).getTime()-e;frameTimes.push(t)}function gameInit(){logging()&&console.log(" wCanvas,width: "+wCanvas.width),graphicsInit(this),scoreCanvasInit(),nextToMove=0}class Point{constructor(e,t){this.x=e,this.y=t}isEqualTo(e){return this.x==e.x&&this.y==e.y}add(e){this.x=this.x+e.x,this.y=this.y+e.y}dist(e){return Math.sqrt((this.x-e.x)*(this.x-e.x)+(this.y-e.y)*(this.y-e.y))}absDiff(e){return new Point(Math.abs(this.x-e.x),Math.abs(this.y-e.y))}wrap(e,t){this.x>=e&&(this.x=this.x-e),this.x<0&&(this.x=this.x+e),this.y>=t&&(this.y=this.y-t),this.y<0&&(this.y=this.y+t)}format(){return"("+this.x+","+this.y+")"}print(){log(" Private class variable "+privateString)}}const instances=[];class MethodChain{static add(e,t,s){getOrCreateMethodChain(e,t).add(s)}static remove(e,t,s){getOrCreateMethodChain(e,t).remove(s)}constructor(e,t){this.context=e,this.methodName=t,this.isTask=/Task$/.test(t),this.originalMethodReference=this.isTask?e.get(t):e[t],this.methodChain=[],this.boundMethodChain=[],this.wrappedMethod=((...e)=>{const t=this.boundMethodChain[this.boundMethodChain.length-1];return t(...e)}),this.isTask?e.set(t,this.wrappedMethod):e[t]=this.wrappedMethod}add(e){this.methodChain.push(e),this.rebindMethodChain()}remove(e){const t=this.methodChain.indexOf(e);t>-1&&(this.methodChain.splice(t,1),this.methodChain.length>0?this.rebindMethodChain():this.destroy())}rebindMethodChain(){this.boundMethodChain=[];for(let e,t=0;e=this.methodChain[t];t++){const s=this.boundMethodChain[t-1]||this.originalMethodReference.bind(this.context);this.boundMethodChain.push(e(s))}}destroy(){const e=instances.indexOf(this);e>-1&&(instances.splice(e,1),this.isTask?this.context.set(this.methodName,this.originalMethodReference):this.context[this.methodName]=this.originalMethodReference)}}const VERSION="2.4.1",DEV_ID="i5iSjo",VERSION_PARAM="_av",USAGE_PARAM="_au",proto=window.Element.prototype,nativeMatches=proto.matches||proto.matchesSelector||proto.webkitMatchesSelector||proto.mozMatchesSelector||proto.msMatchesSelector||proto.oMatchesSelector,a=document.createElement("a"),assign=Object.assign||function(e,...t){for(let s=0,a=t.length;s<a;s++){const a=Object(t[s]);for(let t in a)Object.prototype.hasOwnProperty.call(a,t)&&(e[t]=a[t])}return e},plugins={CLEAN_URL_TRACKER:1,EVENT_TRACKER:2,IMPRESSION_TRACKER:3,MEDIA_QUERY_TRACKER:4,OUTBOUND_FORM_TRACKER:5,OUTBOUND_LINK_TRACKER:6,PAGE_VISIBILITY_TRACKER:7,SOCIAL_WIDGET_TRACKER:8,URL_CHANGE_TRACKER:9,MAX_SCROLL_TRACKER:10},PLUGIN_COUNT=Object.keys(plugins).length;class UrlChangeTracker{constructor(e,t){if(trackUsage(e,plugins.URL_CHANGE_TRACKER),history.pushState&&window.addEventListener){const s={shouldTrackUrlChange:this.shouldTrackUrlChange,trackReplaceState:!1,fieldsObj:{},hitFilter:null};this.opts=assign(s,t),this.tracker=e,this.path=getPath(),this.pushStateOverride=this.pushStateOverride.bind(this),this.replaceStateOverride=this.replaceStateOverride.bind(this),this.handlePopState=this.handlePopState.bind(this),MethodChain.add(history,"pushState",this.pushStateOverride),MethodChain.add(history,"replaceState",this.replaceStateOverride),window.addEventListener("popstate",this.handlePopState)}}pushStateOverride(e){return(...t)=>{e(...t);this.handleUrlChange(!0)}}replaceStateOverride(e){return(...t)=>{e(...t);this.handleUrlChange(!1)}}handlePopState(){this.handleUrlChange(!0)}handleUrlChange(e){setTimeout(()=>{const t=this.path;const s=getPath();if(t!=s&&this.opts.shouldTrackUrlChange.call(this,s,t)&&(this.path=s,this.tracker.set({page:s,title:document.title}),e||this.opts.trackReplaceState)){const e={transport:"beacon"};this.tracker.send("pageview",createFieldsObj(e,this.opts.fieldsObj,this.tracker,this.opts.hitFilter))}},0)}shouldTrackUrlChange(e,t){return!(!e||!t)}remove(){MethodChain.remove(history,"pushState",this.pushStateOverride),MethodChain.remove(history,"replaceState",this.replaceStateOverride),window.removeEventListener("popstate",this.handlePopState)}}provide("urlChangeTracker",UrlChangeTracker),window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-141491749-1","auto"),ga("require","urlChangeTracker"),ga("send","pageview");var darworms$1={version:"0.9.5",host:"https://darworms.com",compassPts:["e","se","sw","w","nw","ne","unSet","isTrapped","ai"],gameStates:{over:0,running:1,waiting:2,paused:3,animToUI:4,animFromUI:5},wormStates:{dead:0,moving:1,paused:2,sleeping:3,dying:4},wormStateNames:["dead","moving","paused","sleeping","dying"],initialWormStates:[3,2,2,2],themes:["c","d","e","f"],selectedIdx:0,gameStateNames:["over","running","waiting","paused","to_ui","from_ui"],outMask:[1,2,4,8,16,32],inMask:[8,16,32,1,2,4],colorNames:["red","green","blue","yellow"],buttonSelectors:["#p1button","#p2button","#p3button","#p4button"],buttonLSelectors:["#p1Lbutton","#p2Lbutton","#p3Lbutton","#p4Lbutton"],inDir:[3,4,5,0,1,2],wCanvasPixelDim:[0,0],wCanvasRef:void 0,minTwoColumnWidth:480,leftColumnWidth:320,screens:{},pickCells:[],graphics:{timer:void 0,scorectx:void 0,animFrame:0,uiFrames:0,rawFrameCount:0,drawFrameCount:0,uiFrameCount:0,xPts:[.5,.25,-.25,-.5,-.25,.25],yPts:[0,.5,.5,0,-.5,-.5],fps:4,frameInterval:33.33333,uifps:30,uiInterval:33.33333,startTime:0,now:0,then:0,uiThen:0,elapsed:0,uiElapsed:0,vertex_x:[.5,.5,0,-.5,-.5,0],vertex_fudge:.12,vertex_y:[.3125,-.3125,-.6875,-.3125,.3125,.6875],hexSize:1,sqrt3:Math.sqrt(3),dyningAnimationFrames:8},selectedDarworm:0,notes:{C1:0,CS:1,DF:1,D:2,DS:3,EF:3,E:4,F:5,FS:6,GF:6,G:7,GS:8,FF:8,AF:8,A:9,AS:10,BF:10,B:11,C2:12},dwsettings:{forceInitialGridSize:!0,largeGridSize:18,smallGridSize:10,tinyGridSize:8,minLargeScreenWidth:800,maxSmallSreenWidth:500,isLargeScreen:!0,doAudio:1,fixedInitPos:!0,pickDirectionUI:0,noWhere:void 0,gridGeometry:"torus",codons:{e:0,ne:1,nw:2,w:3,sw:4,se:5,unSet:6,isTrapped:7,smart:8},colorTable:["#000000","#EE0000","#00EE00","#0404EE","#D0A000","#448833","#443388","#338844","#FF1C0A","#1CFF0A","#1C0AFF","#0AFF1C","#884433","#448833","#443388","#338844"],alphaColorTable:["rgba(  0,   0,   0, 0.2)","rgba(  238,   0,   0, 0.4)","rgba(    0, 128,   0, 0.4)","rgba(    0,   0, 238, 0.4)","rgba(  200, 200, 0, 0.4)","#FFD70080","#5fa40480","#44338880","#33884480","#FF1C0A80","#1CFF0A80","#1C0AFF80","#0AFF1C80","#88443380","#44883380","#44338880","#33884480"],backGroundTheme:0,doAnimations:!0,gridBackground:["#F5F5F5","#404040"],cellBackground:["#F5F5F5","#404040"],masterAudioVolume:.3,dologging:!1,gridSize:18},images:{},audioContext:void 0,masterGainNode:void 0,audioPanner:void 0,audioSamples:[],audioPlaybackRates:[],audioFrequencies:[],audiosamplefiles:[["kalimba","sounds/Roland-SC-88-Kalimba-C5.wav"],["piano","sounds/piano-c2.wav"],["guitar","sounds/Alesis-Fusion-Nylon-String-Guitar-C4.wav"],["bass","sounds/Alesis-Fusion-Acoustic-Bass-C2.wav"],["violin","sounds/Casio-VZ-10M-Pizzicato-Bell-C4.wav"],["flute","sounds/1980s-Casio-Flute-C5.wav"],["flute2","sounds/E-Mu-Proteus-2-Flute-C5.wav"],["koto","sounds/Ensoniq-ESQ-1-Koto-C5.wav"],["sitar","sounds/Sitar-C5.wav"],["alto piano","sounds/Ensoniq-SD-1-Electric-Piano-C6.wav"],["bongo","sounds/Hi-Bongo.wav"],["muted ","sounds/darworm-death.wav"]],gameTxt:null};window.addEventListener("load",function(){window.onerror=function(e,t,s){alert(e+" "+t+" "+s)},$("[data-darworm='selector']").on("pageshow",darworms$1.main.setupEditPage),$("[data-darworm='selector']").on("pagehide",darworms$1.main.setSelectedDarwormType),$("#settingspage").on("pageshow",darworms$1.main.showSettings),$("#settingspage").on("pagebeforeshow",darworms$1.main.setupGridGeometry),$("#settingspage").on("pagehide",darworms$1.main.applySettings),$("#playpage").on("pageshow",darworms$1.main.initPlayPage),$("#playpage").on("pagehide",darworms$1.main.leavePlayPage),$("#edit-darworm-page").on("pageshow",darworms$1.main.initEditPage),$("#edit-darworm-page").on("pagehide",darworms$1.main.leaveditPage),$("#loadsavepage").on("pageshow",darworms$1.main.loadSavedGames),$("#loadsavepage").on("pagehide",darworms$1.main.freeSavedGames),$("#tutorialpopup").popup({afterclose:function(e,t){logging()&&console.log(" afterclose even fired"+$("#tutorialpopup input[type=checkbox]").prop("checked")),$("#tutorialpopup input[type=checkbox]").prop("checked")&&(darworms$1.theGame.focusWorm.showTutorial=!1)}}),logging()&&console.log("About to call darworms.main.init()"),window.darworms=darworms$1,darworms$1.main.init()}),AudioSample.prototype.playSample=function(e,t){var s;void 0!==darworms$1.audioContext&&void 0!==this.savedBuffer&&((s=darworms$1.audioContext.createBufferSource()).buffer=this.savedBuffer,darworms$1.masterGainNode.gain.value=darworms$1.dwsettings.masterAudioVolume,s.connect(darworms$1.masterGainNode),void 0!==darworms$1.audioPanner?(darworms$1.masterGainNode.connect(darworms$1.audioPanner),darworms$1.audioPanner.connect(darworms$1.audioContext.destination)):darworms$1.masterGainNode.connect(darworms$1.audioContext.destination),void 0!==darworms$1.audioPanner&&(darworms$1.audioPanner.pan.value=.8*t),s.start(0),e&&(s.playbackRate.value=e))};const evenRowVec=[{x:1,y:0},{x:0,y:1},{x:-1,y:1},{x:-1,y:0},{x:-1,y:-1},{x:0,y:-1}],oddRowVec=[{x:1,y:0},{x:1,y:1},{x:0,y:1},{x:-1,y:0},{x:0,y:-1},{x:1,y:-1}],spokeMask=[4294967280,4294967055,4294963455,4294905855,4293984255,4279238655,4043309055,268435455],sinkMask=134217728;class Grid{constructor(e,t){this.width=Math.floor(e),this.height=Math.floor(t),this.cells=new Array(e*t),this.colors=new Array(e*t),this.clear()}clear(){for(e=0;e<this.cells.length;e++)this.cells[e]=0;for(e=0;e<this.colors.length;e++)this.colors[e]=0;if("reflect"==darworms$1.dwsettings.gridGeometry){for(var e=0;e<this.width;e+=1){var t=new Point(e,0),s=new Point(e,this.height-1);this.setValueAt(t,this.valueAt(t)|darworms$1.outMask[4]|darworms$1.outMask[5]),this.setValueAt(t,this.valueAt(t)|(63&this.valueAt(t))<<8),this.setSpokeAt(t,4,0),this.setSpokeAt(t,5,0),this.setSpokeAt(t,6,0),this.setValueAt(s,this.valueAt(s)|darworms$1.outMask[1]|darworms$1.outMask[2]),this.setValueAt(s,this.valueAt(s)|(63&this.valueAt(s))<<8),this.setSpokeAt(s,1,0),this.setSpokeAt(s,2,0),this.setSpokeAt(s,6,0)}for(var a=0;a<this.height;a+=1){var r=new Point(0,a),o=new Point(this.width-1,a);0==(1&a)?(this.setValueAt(r,this.valueAt(r)|darworms$1.outMask[2]|darworms$1.outMask[3]|darworms$1.outMask[4]),this.setValueAt(r,this.valueAt(r)|(63&this.valueAt(r))<<8),this.setSpokeAt(r,2,0),this.setSpokeAt(r,3,0),this.setSpokeAt(r,4,0),this.setSpokeAt(r,6,0),this.setValueAt(o,this.valueAt(o)|darworms$1.outMask[0]),this.setValueAt(o,this.valueAt(o)|(63&this.valueAt(o))<<8),this.setSpokeAt(o,0,0),this.setSpokeAt(o,6,0)):(this.setValueAt(r,this.valueAt(r)|darworms$1.outMask[3]),this.setValueAt(r,this.valueAt(r)|(63&this.valueAt(r))<<8),this.setSpokeAt(r,3,0),this.setSpokeAt(r,6,0),this.setValueAt(o,this.valueAt(o)|darworms$1.outMask[5]|darworms$1.outMask[0]|darworms$1.outMask[1]),this.setValueAt(o,this.valueAt(o)|(63&this.valueAt(o))<<8),this.setSpokeAt(o,5,0),this.setSpokeAt(o,0,0),this.setSpokeAt(o,1,0),this.setSpokeAt(o,6,0))}}}valueAt(e){return this.cells[e.y*this.width+e.x]}hexValueAt(e){return" 0x"+this.valueAt(e).toString(16)}stateAt(e){return 63&this.valueAt(e)}outVectorsAt(e){return this.valueAt(e)>>8&63}inVectorsAt(e){return this.valueAt(e)>>16&63}spokeAt(e,t){return this.colors[e.y*this.width+e.x]>>>4*t&7}colorsAt(e){return this.colors[e.y*this.width+e.x]}setSpokeAt(e,t,s){this.colors[e.y*this.width+e.x]=this.colors[e.y*this.width+e.x]&spokeMask[t]|(15&s)<<4*t}setValueAt(e,t){this.cells[e.y*this.width+e.x]=t}setSinkAt(e){this.cells[e.y*this.width+e.x]=this.cells[e.y*this.width+e.x]^sinkMask}isSink(e){return 0!=(this.cells[e.y*this.width+e.x]&sinkMask)}isInside(e){return e.x>=0&&e.y>=0&&e.x<this.width&&e.y<this.height}move(e,t,s,a){0!=(this.inVectorsAt(t)&darworms$1.inMask[s])&&(alert(" Attempted to eat eaten spoke at "+t.format()),logging()&&console.log("  ("+t.x+","+t.y+") dir: "+s+" value: "),logging()&&console.log("Attempted to eat eaten spoke at "+t.format()+" dir "+s+" value: 0x"+this.valueAt(t).toString(16))),this.setValueAt(t,this.valueAt(t)|darworms$1.inMask[s]|darworms$1.inMask[s]<<16),this.setValueAt(e,this.valueAt(e)|darworms$1.outMask[s]|darworms$1.outMask[s]<<8),this.setSpokeAt(e,s,a),this.setSpokeAt(e,6,a),this.setSpokeAt(t,darworms$1.inDir[s],a),this.setSpokeAt(t,6,a);var r=0;return 63===this.stateAt(t)&&(this.setSpokeAt(t,6,a),this.setSpokeAt(t,7,a),r+=1),63===this.stateAt(e)&&(this.setSpokeAt(e,6,a),this.setSpokeAt(e,7,a),r+=1),r}next(e,t){var s=new Point(e.x,e.y);return 0==(1&e.y)?s.add(evenRowVec[t]):s.add(oddRowVec[t]),"falloff"==darworms$1.dwsettings.gridGeometry&&(s.x<0||s.x>this.width-1||s.y<0||s.y>this.height-1)?darworms$1.dwsettings.noWhere:(s.x<0&&(s.x=this.width-1),s.x>this.width-1&&(s.x=0),s.y<0&&(s.y=this.height-1),s.y>this.height-1&&(s.y=0),s)}each(e){for(var t=0;t<this.height;t++)for(var s=0;s<this.width;s++){var a=new Point(s,t);e(a,this.valueAt(a))}}logSpokesAt(e){logging()&&console.log("[ "+e.x+","+e.y+"] val = "+this.colorsAt(e).toString(16));for(var t=0;t<8;t+=1)logging()&&console.log("   spoke: "+t+" colorindex"+this.spokeAt(e,t))}logValueAt(e){logging()&&console.log("[ "+e.x+","+e.y+"] val = 0x"+this.hexValueAt(e)+this.dirList(this.hexValueAt(e))+" outVectors = 0x"+this.outVectorsAt(e).toString(16)+this.dirList(this.outVectorsAt(e))+" inVectors = 0x"+this.inVectorsAt(e).toString(16))}formatStateAt(e){return" x "+e.x+" y "+e.y+" state 0x"+this.stateAt(e).toString(16)}dirList(e){for(var t=" directions ",s=0;s<6;s+=1)0!=(e&darworms$1.outMask[s])&&(t=t+" "+darworms$1.compassPts[s]);return t}}const musicalkeys={"A Major":[darworms$1.notes.A,darworms$1.notes.B,darworms$1.notes.CS,darworms$1.notes.D,darworms$1.notes.E,darworms$1.notes.FS,darworms$1.notes.GS],"B Major":[darworms$1.notes.B,darworms$1.notes.CS,darworms$1.notes.DS,darworms$1.notes.E,darworms$1.notes.FS,darworms$1.notes.GS,darworms$1.notes.AS],"B Minor":[darworms$1.notes.B,darworms$1.notes.CS,darworms$1.notes.D,darworms$1.notes.E,darworms$1.notes.FS,darworms$1.notes.G,darworms$1.notes.A],"C Major":[darworms$1.notes.C1,darworms$1.notes.D,darworms$1.notes.E,darworms$1.notes.F,darworms$1.notes.G,darworms$1.notes.A,darworms$1.notes.B],"C Minor":[darworms$1.notes.C1,darworms$1.notes.D,darworms$1.notes.EF,darworms$1.notes.F,darworms$1.notes.G,darworms$1.notes.AF,darworms$1.notes.BF],"D Major":[darworms$1.notes.D,darworms$1.notes.E,darworms$1.notes.FS,darworms$1.notes.G,darworms$1.notes.A,darworms$1.notes.B,darworms$1.notes.CS],"E Major":[darworms$1.notes.E,darworms$1.notes.FS,darworms$1.notes.GS,darworms$1.notes.A,darworms$1.notes.B,darworms$1.notes.CS,darworms$1.notes.DS],"F Major":[darworms$1.notes.F,darworms$1.notes.G,darworms$1.notes.A,darworms$1.notes.BF,darworms$1.notes.C2,darworms$1.notes.D,darworms$1.notes.E],"F Minor":[darworms$1.notes.F,darworms$1.notes.G,darworms$1.notes.AF,darworms$1.notes.BF,darworms$1.notes.C2,darworms$1.notes.DF,darworms$1.notes.EF],"G Major":[darworms$1.notes.G,darworms$1.notes.A,darworms$1.notes.B,darworms$1.notes.C2,darworms$1.notes.D,darworms$1.notes.E,darworms$1.notes.FS],"G Minor":[darworms$1.notes.G,darworms$1.notes.A,darworms$1.notes.BF,darworms$1.notes.C2,darworms$1.notes.D,darworms$1.notes.EF,darworms$1.notes.F]},dnaregx=/^[ABCDEF\?\*]{63}X$/;class Worm{constructor(e,t){this.colorIndex=e,this.dna=new Array(64),this.state=t,this.nMoves=0,this.score=0,this.prevScore=0,this.numChoices=0,this.died=!1,this.name="",this.wType=0,this.typeName="",this.directionIndex=0,this.diedAtFrame=0,this.showTutorial=!0,this.musickeyName="C Major",this.MusicScale=[],this.audioSamplesPtrs=[],this.pos=new Point(-1,-1),this.startingPos=new Point(-1,-1);for(var s=0;s<64;s+=1)this.dna[s]=darworms$1.dwsettings.codons.unSet;this.dna[63]=darworms$1.dwsettings.codons.isTrapped,this.numChoices=1;for(var a=0;a<6;a+=1)this.dna[63^1<<a]=a,this.numChoices+=1;this.randomize(),this.toText()}init(e){if(this.nMoves=0,this.score=0,this.prevScore=0,this.MusicScale=musicalkeys["C Major"],0===e&&(this.state=3),1===e){for(var t=0;t<64;t+=1)this.dna[t]=darworms$1.dwsettings.codons.unSet;this.dna[63]=darworms$1.dwsettings.codons.isTrapped,this.numChoices=1;for(var s=0;s<6;s+=1)this.dna[63^1<<s]=s,this.numChoices+=1;this.randomize()}if(2===e&&(this.state=2),3===e){for(a=0;a<64;a+=1)this.dna[a]=darworms$1.dwsettings.codons.unSet;this.dna[63]=darworms$1.dwsettings.codons.isTrapped,this.numChoices=1;for(r=0;r<6;r+=1)this.dna[63^1<<r]=r,this.numChoices+=1;this.state=2}if(4===e){for(var a=0;a<64;a+=1)this.dna[a]=darworms$1.dwsettings.codons.smart;this.dna[63]=darworms$1.dwsettings.codons.isTrapped,this.numChoices=1;for(var r=0;r<6;r+=1)this.dna[63^1<<r]=r,this.numChoices+=1;this.state=2}this.toText()}setNotes(e){this.instrument=e,this.audioSamplesPtrs.length=0;for(var t=0;t<7;t+=1)this.audioSamplesPtrs.push(e)}setKey(e){logging()&&console.log(" keyname: "+e),this.musickeyName=e,this.MusicScale=musicalkeys[e]}playScale(){for(var e=0;e<7;e+=1){darworms$1.directionIndex=e;var t=this.MusicScale;t.sort(function(e,t){return e-t}),setTimeout(function(e,t,s){e.audioSamplesPtrs[t]>=0&&darworms$1.audioSamples[e.audioSamplesPtrs[t]].playSample(darworms$1.audioPlaybackRates[s[t]],0)},500*e,this,e,t)}}getMoveDir(e){return 63===e?(this.state=wormStates.dead,this.died=!0,6):this.dna[63&e]}shouldDrawScore(){return this.score!==this.prevScore||this.nMoves<=2?(this.prevScore=this.score,!0):!!this.died&&(this.died=!1,!0)}randomize(){for(var e,t=0;t<63;t+=1)if(this.dna[t]===darworms$1.dwsettings.codons.unSet){for(var s=0;s<1e3;s+=1)if(e=Math.floor(6*Math.random()),0==(t&darworms$1.outMask[e])){this.dna[t]=e,this.numChoices+=1;break}this.dna[t]===darworms$1.dwsettings.codons.unSet&&logging()&&console.log("Error we rolled craps 10,000 times in a row")}this.toText()}log(){logging()&&console.log(" Worm State: "+darworms$1.wormStateNames[this.state]+" at "+(void 0!==this.pos?this.pos.format():"position Undefined"))}place(e,t,s){this.pos=s,this.startingPos=s,this.nMoves=0,this.score=0,this.state=e,logging()&&console.log(" placing worm   i = "+this.colorIndex+" state "+e+" "+this.numChoices+" of 64 possible moves defined")}dump(){for(var e=0;e<64;e+=1){logging()&&console.log(" dna"+e+" = "+darworms$1.compassPts[this.dna[e]]);for(var t=[],s=0;s<6;s+=1)0!=(e&darworms$1.outMask[s])&&t.push(darworms$1.compassPts[s]);logging()&&console.log(" dna"+e+" "+t+" = "+darworms$1.compassPts[this.dna[e]])}}toText(){this.name="";for(var e=0;e<64;e+=1)0===this.dna[e]&&(this.name+="A"),1===this.dna[e]&&(this.name+="B"),2===this.dna[e]&&(this.name+="C"),3===this.dna[e]&&(this.name+="D"),4===this.dna[e]&&(this.name+="E"),5===this.dna[e]&&(this.name+="F"),6===this.dna[e]&&(this.name+="?"),7===this.dna[e]&&(this.name+="X"),8===this.dna[e]&&(this.name+="*"),this.dna[e]>8&&(this.name+="#");return this.name}fromText(e){if(!dnaregx.test(e))return alert("illegal character in dna  "+e),t=!1,!1;for(var t=!0,s=0;s<63;s+=1){switch(e.charAt(s)){case"A":this.dna[s]=0;break;case"B":this.dna[s]=1;break;case"C":this.dna[s]=2;break;case"D":this.dna[s]=3;break;case"E":this.dna[s]=4;break;case"F":this.dna[s]=5;break;case"?":this.dna[s]=6;break;case"*":this.dna[s]=8;break;default:return alert(" illegal dna string at position "+(s+1)),!1}0!=(1<<this.dna[s]&s)&&6!==this.dna[s]&&8!==this.dna[s]&&(alert("illegal direction "+e.charAt(s)+" ("+darworms$1.compassPts[this.dna[s]]+")given for cell "+s),t=!1)}return t&&this.toText(),t}emailDarworm(){logging()&&console.log("Emailing: "+this.toText());var e="mailto:?subject="+encodeURIComponent("Check out this cool Darworm")+"&body="+encodeURIComponent("Darworms is a free web game available at \n")+encodeURIComponent(darworms$1.host+"\n")+encodeURIComponent("You can copy the darworm string below and then go to the game and paste the text into one of the players\n")+encodeURIComponent(this.toText());logging()&&console.log("url: "+e),window.open(e)}getNumGenes(e){const t=(t,s)=>t+(s===e?1:0);return this.dna.reduce(t,0)}getSmartMove(e,t,s){const a=[1,2,4,8,16,32],r=[3,4,5,0,1,2],o=[0,10,40,10,60,0,0],i=(e,t)=>e+(8==t?0:1);var n=this.dna.reduce(i,0);e.forEach(e=>{e.score=0;var i=(t,s)=>t+(s==e.dir?1:0);var d=this.dna.reduce(i,0);d<n/6&&(e.score+=30);1==d&&(e.score+=60);e.score+=o[numOneBits(e.spokes)];this.pos.x<t.x&&(0==e.dir||1==e.dir||5==e.dir)&&(e.score+=30);this.pos.x>t.x&&(2==e.dir||3==e.dir||4==e.dir)&&(e.score+=30);this.pos.y<t.y&&(1==e.dir||2==e.dir)&&(e.score+=30);this.pos.y>t.y&&(4==e.dir||5==e.dir)&&(e.score+=30);a.forEach((t,a)=>{t==s&&e.dir!=r[a]&&(e.score+=30)})});var d=(e,t)=>e+t.score,m=e.reduce(d,0),c=-1,w=Math.floor(Math.random()*m);return e.forEach(e=>{w>0&&w<e.score?c=e.dir:w-=e.score}),c>0?c:e[Math.floor(Math.random()*e.length)].dir}completeDarwormAI(){logging()&&console.log(" complete completeDarwormAI called"),this.dna.forEach((e,t)=>{e===darworms$1.dwsettings.codons.unSet&&(this.dna[t]=darworms$1.dwsettings.codons.smart)})}completeDarwormRand(){logging()&&console.log(" complete completeDarwormRand called"),this.dna.forEach((e,t)=>{var s=[];if(e===darworms$1.dwsettings.codons.unSet){for(var a=0;a<6;a++)0==(t&darworms$1.outMask[a])&&s.push(a);this.dna[t]=s[Math.floor(Math.random()*s.length)]}})}}const xPts=[.8,.4,-.4,-.8,-.4,.4],yPts=[0,.67,.67,0,-.67,-.67];let pGraphics=null;var wGraphics,wCanvas,scale,grid;let xPts$1=[1,.5,-.5,-1,-.5,.5],yPts$1=[0,1,1,0,-1,-1],asterixSize=.2,timeInDraw=0,gameElapsedTime=0,frameTimes=[],startFrameTimes=[],dirtyCells=[],theGame=null;var scoreCanvas,scorectx;let gameObj={},gameTxt="",gameUrl="";var nextToMove,focusPoint;const maxpan=.8;class Game{constructor(e,t){wCanvas.width=$("#wcanvas").width(),wCanvas.height=$("#wcanvas").height(),this.gameState=darworms$1.gameStates.over,this.grid=new Grid(e,t),setGrid(this.grid,this),this.numTurns=0,this.numMoves=0,this.activeIndex=0,setScale(e,t),logging()&&console.log(" new Game scale set to "+scale.format()),this.origin=new Point(e>>1,t>>1),focusPoint=this.origin,this.worms=[],this.needsRedraw=!0,this.avePos=new Point(0,0),this.focusWorm=null,this.focusValure=null,this.xPts=[1,.5,-.5,-1,-.5,.5],this.yPts=[0,1,1,0,-1,-1],(scale.x<20||scale.y<20)&&($("#pickDirectionUI").slider().val(1),$("#pickDirectionUI").slider("refresh"),darworms$1.dwsettings.pickDirectionUI=1),logging()&&console.log(" Scale: "+scale.format()+"darworms.dwsettings.pickDirectionUI: "+darworms$1.dwsettings.pickDirectionUI),this.zoomFrame=0,this.startx=0,this.starty=0,this.endx=0,this.endy=0,this.startscale=1,this.endScale=1,this.targetZoomFrames=60,this.asterixSize=.2,this.bullseyeoffset=new Point(0,0),this.focusWorm=null}updateScale(e,t){setScale(this.grid.width,this.grid.height),logging()&&console.log("updateScale "+scale.format())}logGame(){logging()&&console.log(" Game grid size  "+new Point(this.grid.width,this.grid.height).format()),logging()&&console.log(" Game Canvas size  "+new Point(wCanvas.width,wCanvas.height).format()),logging()&&console.log(" Game scale "+scale.format());for(var e=0;e<this.worms.length;e+=1)logging()&&console.log(" Game worm "+e+" :  "+this.worms[e].state+" at "+this.worms[e].pos.format()+" value:"+this.grid.hexValueAt(this.worms[e].pos))}printNonEmpty(){this.grid.each(function(e,t){t>0&&logging()&&console.log("NonEmpty "+e.format()+" value: 0x"+t.toString(16))})}initGame(){clearCanvas(),this.grid.clear(),setGrid(this.grid,this),drawCells(),startGameTimer(),this.numMoves=0,this.numTurns=0,this.timeInDraw=0}addWorm(e){e.pos=this.origin,e.nMoves=0,e.score=0,e.state=darworms$1.wormStates.paused,this.worms.push(e)}getAvePos(e){var t=0;this.avePos.x=0,this.avePos.y=0;for(var s=0;s<this.worms.length;s+=1){var a=this.worms[s];a.state===darworms$1.wormStates.moving&&(this.avePos.x=this.avePos.x+a.pos.x,this.avePos.y=this.avePos.y+a.pos.y,t+=1)}t>1&&(this.avePos.x=Math.floor(this.avePos.x/t),this.avePos.y=Math.floor(this.avePos.y/t))}makeMove(e){var t=0;if(this.gameState!==darworms$1.gameStates.waiting){for(var s=nextToMove;s<this.worms.length;s+=1){var a=this.worms[s];if(darworms$1.theGame.activeIndex=s,a.state!==darworms$1.wormStates.sleeping){var r=this.grid.stateAt(a.pos);if(63==r)a.state!=darworms$1.wormStates.dead&&a.state!=darworms$1.wormStates.dying&&(darworms$1.dwsettings.doAnimations&&1==darworms$1.dwsettings.doAudio&&darworms$1.audioSamples[darworms$1.audioSamples.length-1]&&darworms$1.audioSamples[darworms$1.audioSamples.length-1].playSample(1,0),a.state=darworms$1.dwsettings.doAnimations?darworms$1.wormStates.dying:darworms$1.wormStates.dead,a.diedAtFrame=darworms$1.graphics.uiFrames,logging()&&console.log(" darworm "+a.colorIndex+" dying at frame: "+darworms$1.graphics.animFrame)),a.state==darworms$1.wormStates.dying&&darworms$1.graphics.uiFrames-a.diedAtFrame>darworms$1.graphics.dyningAnimationFrames&&(a.state=darworms$1.wormStates.dead,logging()&&console.log(" darworm "+a.colorIndex+" dead at frame: "+darworms$1.graphics.animFrame));else{var o=a.getMoveDir(r);if(o===darworms$1.dwsettings.codons.smart){for(var i=this.grid.outVectorsAt(a.pos),n=this.grid.inVectorsAt(a.pos),d=[],m=new Point(this.grid.width/2,this.grid.width/2),c=0;c<6;c+=1)if(0==(i&darworms$1.outMask[c])&&0==(n&darworms$1.outMask[c])){var w={};w.pos=this.grid.next(a.pos,c),w.dir=c,w.spokes=63&this.grid.valueAt(w.pos),d.push(w)}o=a.getSmartMove(d,m,r),a.dna[r]=63&o}if(o===darworms$1.dwsettings.codons.unSet){if(this.gameState=darworms$1.gameStates.waiting,focusPoint=a.pos,darworms$1.theGame.focusWorm=a,darworms$1.theGame.focusValue=r,darworms$1.theGame.focusWorm.showTutorial){$("input[type='checkbox']").attr("checked",!1);var h=["#p1button","#p2button","#p3buton","#p4button"];$("#tutorialpopup").popup("option","theme",darworms$1.themes[darworms$1.theGame.activeIndex]),logging()&&console.log(" init popup here"),drawdna(document.getElementById("popupcanvas"),a,r),$("#tutorialpopup").popup("open",{positionTo:h[darworms$1.theGame.activeIndex]})}return nextToMove=s,this.numMoves=this.numMoves+1,a.nMoves=a.nMoves+1,drawDirtyCells(),initPickUI(a),!0}pushDirtyCell(a.pos);var l=this.grid.next(a.pos,o);if(l.isEqualTo(darworms$1.dwsettings.noWhere))a.state=darworms$1.wormStates.dead,a.died=!0;else{var g=this.grid.move(a.pos,l,o,a.colorIndex);if(a.score=a.score+g,this.numMoves=this.numMoves+1,a.nMoves=a.nMoves+1,a.pos=l,pushDirtyCell(l),1==darworms$1.dwsettings.doAudio&&e&&a.instrument<darworms$1.audiosamplefiles.length-1){let e=(a.pos.x-darworms$1.theGame.grid.width/2)/(darworms$1.theGame.grid.width/2)*.8;void 0!==a.audioSamplesPtrs[o]&&a.audioSamplesPtrs[o]>=0&&darworms$1.audioSamples[a.audioSamplesPtrs[o]].playSample(darworms$1.audioPlaybackRates[a.MusicScale[1==g?6:o]],e)}}}a.state!==darworms$1.wormStates.dead&&(t+=1)}}return nextToMove=0,this.numTurns=this.numTurns+1,t>0||0!==nextToMove}}convertCanvasToImage(e){var t=new Image;return t.src=e.toDataURL("image/png"),t}}darworms$1.main=function(){function e(e){function t(){e.resume().then(s)}function s(){events.forEach(e=>b.removeEventListener(e,t))}if("suspended"===e.state){const e=document.body,s=["touchstart","touchend","mousedown","keydown"];s.forEach(s=>e.addEventListener(s,t,!1))}}var t=function(){alert("This is a deviceInfo."),document.getElementById("width").innerHTML=screen.width,document.getElementById("height").innerHTML=screen.height,document.getElementById("colorDepth").innerHTML=screen.colorDepth},s=[3,0,1,0],a=["#p1button","#p2button","#p3button","#p4button","#p1Lbutton","#p2Lbutton","#p3Lbutton","#p4Lbutton"],r=[" None ","Random"," Same "," New  ","Smart"],o=["#p1textfield","#p2textfield","#p3textfield","#p4textfield","#edittextfield"],i=[new Worm(1,darworms$1.wormStates.paused),new Worm(2,darworms$1.wormStates.paused),new Worm(3,darworms$1.wormStates.paused),new Worm(4,darworms$1.wormStates.paused)],n=function(){$("#p1button").text(r[s[0]]),$("#p2button").text(r[s[1]]),$("#p3button").text(r[s[2]]),$("#p4button").text(r[s[3]]),$("#p1Lbutton").text(r[s[0]]),$("#p2Lbutton").text(r[s[1]]),$("#p3Lbutton").text(r[s[2]]),$("#p4Lbutton").text(r[s[3]]);$("#p4button")[0];i.forEach(function(e,t){e.wType=s[t],e.typeName=r[e.wType],$(a[t]).removeClass(0===s[t]?"ui-opaque":"ui-grayed-out"),$(a[t]).addClass(0===s[t]?"ui-grayed-out":"ui-opaque")})},d=function(){if(darworms$1.theGame&&darworms$1.theGame.gameState!==darworms$1.gameStates.over)$(".darwormTypeRadioButtons").hide(),$(".playKeyNotes").hide();else{$(".darwormTypeRadioButtons").show(),$(".playKeyNotes").show();var e=s[darworms$1.selectedIdx];darworms$1.colorNames[darworms$1.selectedIdx];switch(e){case 0:$("#edit-radio-choice-1").prop("checked",!0).checkboxradio("refresh");break;case 1:$("#edit-radio-choice-2").prop("checked",!0).checkboxradio("refresh");break;case 2:$("#edit-radio-choice-3").prop("checked",!0).checkboxradio("refresh");break;case 3:$("#edit-radio-choice-4").prop("checked",!0).checkboxradio("refresh");break;case 4:$("#edit-radio-choice-5").prop("checked",!0).checkboxradio("refresh")}$("input[name=edit-radio-choice]").checkboxradio("refresh"),$("input[name='edit-textname']").textinput({theme:darworms$1.themes[darworms$1.selectedIdx]}),$(o[4]).val(0==s[darworms$1.selectedIdx]?"":i[darworms$1.selectedIdx].name)}},m=function(){n()},c=function(){darworms$1.theGame&&darworms$1.theGame.gameState!==darworms$1.gameStates.over?($("#geometryradios").hide(),$("#gridsizeslider").hide(),$("#abortgame").show()):($("#geometryradios").show(),$("#gridsizeslider").show(),$("#abortgame").hide()),$("#fps").val(darworms$1.graphics.fps).slider("refresh"),$("#gridsize").val(darworms$1.dwsettings.gridSize).slider("refresh"),$("#backg").val(darworms$1.dwsettings.backGroundTheme).slider("refresh"),$("#doanim").val(darworms$1.dwsettings.doAnimations).slider("refresh"),$("#audioon").val(darworms$1.dwsettings.doAudio).slider("refresh"),$("#fixedinitpos").val(darworms$1.dwsettings.fixedInitPos).slider("refresh"),$("#pickDirectionUI").val(darworms$1.dwsettings.pickDirectionUI).slider("refresh")},w=function(){darworms$1.dwsettings.gridGeometry=$("input[name=geometry-radio-choice]:checked").val(),darworms$1.dwsettings.backGroundTheme!==$("#backg").slider().val()&&(darworms$1.dwsettings.backGroundTheme=$("#backg").slider().val(),darworms$1.theGame&&(clearCanvas(),drawCells())),darworms$1.dwsettings.gridSize=parseInt($("#gridsize").val()),darworms$1.dwsettings.doAnimations="true"==$("#doanim").slider().val(),darworms$1.dwsettings.doAudio="1"==$("#audioon").slider().val()?1:0,darworms$1.dwsettings.fixedInitPos="1"==$("#fixedinitpos").slider().val()?1:0,darworms$1.dwsettings.pickDirectionUI="1"==$("#pickDirectionUI").slider().val()?1:0,logging()&&console.log(" darworms.dwsettings.doAnimations "+darworms$1.dwsettings.doAnimations),logging()&&console.log(" darworms.dwsettings.doAudio "+darworms$1.dwsettings.doAudio),darworms$1.dwsettings.masterAudioVolume=$("#audiovol").val()/100,darworms$1.graphics.fps=parseInt($("#fps").val()),darworms$1.graphics.frameInterval=1e3/darworms$1.graphics.fps,logging()&&console.log(" darworms.dwsettings.masterAudioVolume "+darworms$1.dwsettings.masterAudioVolume)},h=function(e){var t=JSON.parse(e);return darworms$1.dwsettings.gridGeometry=t.gridGeometry,darworms$1.dwsettings.backGroundTheme!==t.backGroundTheme&&(darworms$1.dwsettings.backGroundTheme=t.backGroundTheme,darworms$1.theGame&&(clearCanvas(),drawCells())),darworms$1.dwsettings.doAnimations=t.doAnimations,darworms$1.dwsettings.doAudio=t.doAudio,darworms$1.dwsettings.fixedInitPos=t.fixedInitPos,darworms$1.dwsettings.pickDirectionUI=t.pickDirectionUI,darworms$1.dwsettings.masterAudioVolume=t.masterAudioVolume,darworms$1.graphics.fps=t.fps,darworms$1.graphics.frameInterval=1e3/darworms$1.graphics.fps,darworms$1.dwsettings.gridSize=t.width,t.players.forEach(function(e){var t=e.index;i[t].name=e.name,dnaregx.test(i[t].name)&&(i[t].fromText(i[t].name)||(alert("Invalid DNA for Daworm # "+(t+1)+" "),i[t].wType=0)),i[t].fromText(e.name),i[t].wType=" None "==e.typeName?0:2,s[t]=i[t].wType,i[t].score=e.score,i[t].instrument=e.instrument,i[t].setNotes(e.instrument),i[t].musickeyName=e.musickeyName,i[t].MusicScale=e.MusicScale}),t},l=function(){logging()&&console.log(" pagebeforeshow setupGridGeometry "),darworms$1.theGame&&darworms$1.theGame.gameState!==darworms$1.gameStates.over?$("#geometryradios").hide():$("#geometryradios").show();var e=darworms$1.dwsettings.gridGeometry;switch(e){case"torus":$("#geometry-radio-torus").prop("checked",!0).checkboxradio("refresh");break;case"falloff":$("#geometry-radio-falloff").prop("checked",!0).checkboxradio("refresh");break;case"reflect":$("#geometry-radio-reflect").prop("checked",!0).checkboxradio("refresh");break;default:alert(" unknown grid geometry requested: "+e)}},g=function(e){var t={x:0,y:0};if("touchstart"==e.type||"touchmove"==e.type||"touchend"==e.type||"touchcancel"==e.type){var s=e.originalEvent.touches[0]||e.originalEvent.changedTouches[0];t.x=s.pageX,t.y=s.pageY}else"mousedown"==e.type||"mouseup"==e.type||"mousemove"==e.type||"mouseover"==e.type||"mouseout"==e.type||"mouseenter"==e.type||"mouseleave"==e.type?(t.x=e.pageX,t.y=e.pageY):"tap"==e.type&&(t.x=(e.clientX||e.changedTouches[0].pageX)-e.currentTarget.offsetLeft,t.y=(e.clientY||e.changedTouches[0].pageY)-e.currentTarget.offsetTop);return t},u=function(e){var t=g(e),s=t.x,a=t.y;logging()&&console.log(" Tap Event at x: "+s+" y: "+a),darworms$1.theGame.gameState===darworms$1.gameStates.waiting&&selectDirection(new Point(s,a))};darworms$1.menuButton=function(){logging()&&console.log(" menuButton"),!darworms$1.theGame.gameState||darworms$1.theGame.gameState!=darworms$1.gameStates.running&&darworms$1.theGame.gameState!=darworms$1.gameStates.paused?darworms$1.theGame.gameState==darworms$1.gameStates.waiting?$.mobile.changePage("#settingspage"):$.mobile.changePage("#menupage"):(darworms$1.theGame.gameState=darworms$1.gameStates.paused,$.mobile.changePage("#settingspage"),darworms$1.theGame.needsRedraw=!0,drawCells(),$("#startpause").text("Resume Game"))},darworms$1.setKeyVal=function(e){var t=$("#select-native-key");1==t.length&&i[darworms$1.selectedIdx].setKey(t.val())},darworms$1.setInstrumentVal=function(e){var t=$("#select-instrument-dropdown");if(1==t.length){var s=parseInt(t.val());i[darworms$1.selectedIdx].setNotes(s)}},darworms$1.sendemail=function(){logging()&&console.log(" sendEMail "+darworms$1.gameTxt),emailGame(darworms$1.gameTxt)},darworms$1.saveGame=function(){logging()&&console.log(" saveGame "),saveGame(darworms$1.gameTxt)},darworms$1.startgame=function(e){logging()&&console.log(" Startgame start now = "+e),darworms$1.theGame&&logging()&&console.log("GameState is "+darworms$1.theGame.gameState+darworms$1.gameStateNames[darworms$1.theGame.gameState]),darworms$1.dwsettings.isLargeScreen=wCanvas.width>=darworms$1.dwsettings.minLargeScreenWidth;var t=new Point(wCanvas.width,wCanvas.height);if(darworms$1.wCanvasPixelDim=t,void 0!==darworms$1.theGame&&null!==darworms$1.theGame&&darworms$1.theGame.grid.height==darworms$1.dwsettings.gridSize&&darworms$1.wCanvasPixelDim.isEqualTo(t)||(logging()&&console.log(" theGame size has changed Screen is"+t.format()+" grid = "+darworms$1.dwsettings.gridSize+" x "+darworms$1.dwsettings.gridSize),0!=(1&darworms$1.dwsettings.gridSize)&&(darworms$1.dwsettings.gridSize=darworms$1.dwsettings.gridSize+1),1===$("#debug").slider().val()&&alert(" wCanvas "+wCanvas.width+" x "+wCanvas.height+" css "+$("#wcanvas").width()+" x "+$("#wcanvas").height()+" window "+window.innerWidth+" x "+window.innerHeight),darworms$1.theGame=new Game(darworms$1.dwsettings.gridSize,darworms$1.dwsettings.gridSize)),darworms$1.theGame.gameState===darworms$1.gameStates.over&&(darworms$1.theGame.initGame(),$("#startpause").text("Start Game"),darworms$1.theGame.needsRedraw=!0,drawCells(),darworms$1.theGame.worms=i,logging()&&console.log(" init gridsize: "+$("#gridsize").val()+" gHeight"+darworms$1.dwsettings.gridSize),i.forEach(function(e,t){e.init(s[t]),0!==s[t]?$(a[t]).addClass("ui-opaque"):$(a[t]).addClass("ui-grayed-out");var r=1==darworms$1.dwsettings.fixedInitPos?darworms$1.theGame.origin:2==s[t]?e.startingPos:new Point(Math.floor(Math.random()*darworms$1.theGame.grid.width),Math.floor(Math.random()*darworms$1.theGame.grid.height));e.place(darworms$1.initialWormStates[s[t]],darworms$1.theGame,r),0!==s[t]&&darworms$1.theGame.grid.setSinkAt(r)})),n(),!1!==e){if(updateScores(i),logging()&&console.log(" NEW in startgame darworms.dwsettings.doAnimations "+darworms$1.dwsettings.doAnimations),darworms$1.theGame.gameState===darworms$1.gameStates.running)return $("#startpause").text("Resume Game"),darworms$1.theGame.gameState=darworms$1.gameStates.paused,darworms$1.theGame.needsRedraw=!0,void drawCells();if(darworms$1.theGame.gameState===darworms$1.gameStates.paused)return $("#startpause").text("Pause"),void(darworms$1.theGame.gameState=darworms$1.gameStates.running);if(darworms$1.theGame.gameState===darworms$1.gameStates.over){darworms$1.theGame.gameState=darworms$1.gameStates.running;var r=darworms$1.dwsettings.doAnimations?darworms$1.graphics.fps:60;p(r),logging()&&console.log(" setInterval: "+1e3/$("#fps").val()),$("#startpause").text("Pause Game"),v(!0),darworms$1.theGame.logGame()}darworms$1.dwsettings.doAnimations||(logging()&&console.log('darworms.dwsettings.doAnimations == "false"'),darworms$1.theGame.gameState=darworms$1.gameStates.running,clearCanvas(),drawCells(),logging()&&console.log(" Game Running"),$("#startpause").text("Running"))}};var p=function(e){darworms$1.graphics.fps=e,darworms$1.graphics.frameInterval=1e3/e,darworms$1.graphics.iufps=30,darworms$1.graphics.uiInterval=1e3/e,darworms$1.graphics.animFrame=0,darworms$1.graphics.uiFrames=0,darworms$1.graphics.rawFrameCount=0,darworms$1.graphics.drawFrameCount=0,darworms$1.graphics.rawFrameCount=0,darworms$1.graphics.uiFrameCount=0,darworms$1.graphics.then=Date.now(),darworms$1.graphics.uiThen=Date.now(),darworms$1.graphics.startTime=darworms$1.graphics.then,darworms$1.graphics.uiInterval=1e3/darworms$1.graphics.uifps,f()},f=function(){if(darworms$1.graphics.rawFrameCount++,darworms$1.theGame.gameState==darworms$1.gameStates.over){i.forEach(function(e,t){3!=e.wType&&4!=e.wType||(e.wType=2),e.toText()});for(let e=0;e<4;e++)s[e]=i[e].wType;return void n()}if(requestAnimationFrame(f),darworms$1.graphics.animFrame=darworms$1.graphics.animFrame+1,darworms$1.theGame.gameState===darworms$1.gameStates.running)if(darworms$1.graphics.now=Date.now(),darworms$1.dwsettings.doAnimations)darworms$1.graphics.elapsed=darworms$1.graphics.now-darworms$1.graphics.then,darworms$1.graphics.elapsed>darworms$1.graphics.frameInterval&&(darworms$1.graphics.uiFrames=darworms$1.graphics.uiFrames+1,makeMoves(),darworms$1.graphics.then=darworms$1.graphics.now-darworms$1.graphics.elapsed%darworms$1.graphics.frameInterval);else{for(var e=Date.now(),t=0;t<80&&darworms$1.theGame.gameState!=darworms$1.gameStates.over&&darworms$1.theGame.gameState!==darworms$1.gameStates.waiting;)t+=1,makeMoves();logging()&&console.log("Compute time: "+(Date.now()-e));e=Date.now();updateScores(darworms$1.theGame.worms),drawDirtyCells(),logging()&&console.log("Draw time: "+(Date.now()-e)),logging()&&console.log(".")}darworms$1.theGame.gameState===darworms$1.gameStates.waiting&&(darworms$1.graphics.now=Date.now(),darworms$1.graphics.uiElapsed=darworms$1.graphics.now-darworms$1.graphics.uiThen,darworms$1.graphics.uiElapsed>darworms$1.graphics.uiInterval&&(drawPickCells(),darworms$1.graphics.uiThen=darworms$1.graphics.now-darworms$1.graphics.uiElapsed%darworms$1.graphics.uiInterval))};darworms$1.abortgame=function(){logging()&&console.log("Abort Game called"),$.mobile.changePage("#abortdialog","pop",!0,!0)},darworms$1.emailDarwormButton=function(e){logging()&&console.log("emailDarwormButton called"),i[darworms$1.selectedIdx].emailDarworm()},darworms$1.playScale=function(e){logging()&&console.log("playScale called"),i[darworms$1.selectedIdx].playScale()},darworms$1.completeTrainingAI=function(e){logging()&&console.log(" completeTrainingAI "),i[darworms$1.selectedIdx].completeDarwormAI(),i[darworms$1.selectedIdx].toText(),$("#edittextfield").val(0==i[darworms$1.selectedIdx].wType?"":i[darworms$1.selectedIdx].name),$("#completeButton").hide(),$("#darwormdeflabel").text(y(i[darworms$1.selectedIdx])),i[darworms$1.selectedIdx].wType=2,s[darworms$1.selectedIdx]=2},darworms$1.completeTrainingRand=function(e){logging()&&console.log(" completeTrainingAI "),i[darworms$1.selectedIdx].completeDarwormRand(),i[darworms$1.selectedIdx].toText(),$("#edittextfield").val(0==i[darworms$1.selectedIdx].wType?"":i[darworms$1.selectedIdx].name),$("#completeButton").hide(),$("#darwormdeflabel").text(y(i[darworms$1.selectedIdx])),i[darworms$1.selectedIdx].wType=2,s[darworms$1.selectedIdx]=2},darworms$1.yesabortgame=function(){logging()&&console.log("Abort Game called"),$.mobile.changePage("#playpage"),darworms$1.theGame.gameState=darworms$1.gameStates.over,darworms$1.startgame(!1)},darworms$1.noabortgame=function(){logging()&&console.log("Abort Game called"),$.mobile.changePage("#settingspage")};var v=function(e){darworms$1.theGame.gameState=e?darworms$1.gameStates.running:darworms$1.gameStates.over,darworms$1.theGame.needsRedraw=!0},x=function(e,t){e.removeClass("ui-page-theme-c"),e.removeClass("ui-page-theme-d"),e.removeClass("ui-page-theme-e"),e.removeClass("ui-page-theme-f"),e.page("option","theme",t)},S=function(e){if(logging()&&console.log(" initEditPage "+darworms$1.selectedIdx),x($("#edit-darworm-page"),darworms$1.themes[darworms$1.selectedIdx]),$("#edittextfield").val(0==i[darworms$1.selectedIdx].wType?"":i[darworms$1.selectedIdx].name),$("[name=select-instrument]").val(i[darworms$1.selectedIdx].instrument),$("[name=select-instrument]").selectmenu("refresh"),$("[name=select-key]").val(i[darworms$1.selectedIdx].musickeyName),$("[name=select-key]").selectmenu("refresh"),$("#edit-darworm-page").trigger("create"),0==i[darworms$1.selectedIdx].wType)$("#darwormdeflabel").text("Darworm DNA");else{var t=i[darworms$1.selectedIdx].getNumGenes(darworms$1.dwsettings.codons.unSet);$("#darwormdeflabel").text(y(i[darworms$1.selectedIdx])),t>0?$("#completeButton").show():$("#completeButton").hide()}},G=function(){if(darworms$1.audioContext=new(window.AudioContext||window.webkitAudioContext),null==darworms$1.audioContext&&(darworms$1.dwsettings.doAudio=!1,alert(" Could not load webAudio... muting game"),$("#doAudio").hide()),e(darworms$1.audioContext),logging()&&console.log("audio is "+darworms$1.dwsettings.doAudio+"  Context state is "+darworms$1.audioContext.state),darworms$1.dwsettings.doAudio){void 0!==darworms$1.audioContext.createGain&&(darworms$1.masterGainNode=darworms$1.audioContext.createGain(.5)),void 0!==darworms$1.audioContext.createStereoPanner&&(darworms$1.audioPanner=darworms$1.audioContext.createStereoPanner());var t=$("#select-instrument-dropdown");darworms$1.audiosamplefiles.forEach(function(e,s){new AudioSample(e[0],e[1]);var a='<option value="'+s+'">'+e[0]+"</option>";t.append(a),t.selectmenu(),t.selectmenu("refresh",!0)});var s=$("#select-native-key");Object.keys(musicalkeys).forEach(e=>{var t='<option value="'+e+'">'+e+"</option>";s.append(t);s.selectmenu();s.selectmenu("refresh",!0)})}var a=.5;do{darworms$1.audioPlaybackRates.push(a),darworms$1.audioFrequencies.push(261.626*a),a*=1.05946309436}while(darworms$1.audioPlaybackRates.length<13);if(logging()&&console.log("Final rate = "+darworms$1.audioPlaybackRates[12]+"  error: "+(1-darworms$1.audioPlaybackRates[12])),darworms$1.audioPlaybackRates[12]=1,"suspended"===darworms$1.audioContext.state){var r=function(){darworms$1.audioContext.resume(),setTimeout(function(){"running"===darworms$1.audioContext.state&&document.body.removeEventListener("touchend",r,!1)},0)};document.body.addEventListener("touchend",r,!1)}},y=function(e){var t=e.getNumGenes(darworms$1.dwsettings.codons.unSet),s=e.getNumGenes(darworms$1.dwsettings.codons.smart);return"Darworm DNA: "+t+" untrained "+(64-(t+s))+" trained "+s+" awaiting ai "},k=function(e){switch(e){case"none":return 0;case"smart":return 4;case"random":return 1;case"same":return 2;case"new":return 3;default:return alert("unknown type (not none, randowm, new or same)"),0}};return{init:function(){document.addEventListener("deviceready",t,!0),logging()&&console.log("development mode: "+darworms$1.dwsettings.dologging),logging()&&console.log("width: "+$(window).width()),$("#logging").slider().val(darworms$1.dwsettings.dologging?"true":"false"),$("#versionstring")[0].innerHTML="Version "+darworms$1.version;try{const e=new URLSearchParams(window.location.search);logging()&&console.log(location.search),e.has("darwormsgame")&&(darworms$1.gameTxt=decodeURIComponent(e.get("darwormsgame")),darworms$1.gameTxt&&(h(darworms$1.gameTxt),scoreCanvasInit(),updateScores(i),$.mobile.changePage("#playpage"),darworms$1.dwsettings.forceInitialGridSize=!1))}catch(e){alert("Trouble parsing the url. Be sure to copy and paste the entire url starting with 'https' all way through to the lst '}' \n"+e.message)}graphicsInit(),darworms$1.dwsettings.isLargeScreen=$(window).width()>=darworms$1.dwsettings.minLargeScreenWidth,darworms$1.dwsettings.isTinyScreen=$(window).width()<darworms$1.dwsettings.maxSmallSreenWidth,darworms$1.dwsettings.forceInitialGridSize&&(darworms$1.dwsettings.gridSize=darworms$1.dwsettings.isLargeScreen?darworms$1.dwsettings.largeGridSize:darworms$1.dwsettings.isTinyScreen?darworms$1.dwsettings.tinyGridSize:darworms$1.dwsettings.smallGridSize),darworms$1.wCanvasPixelDim=new Point(wCanvas.clientWidth,wCanvas.clientHeight),$("#wcanvas").bind("tap",u),$("#pickDirectionUI").slider().val(0),$("#pickDirectionUI").slider("refresh"),darworms$1.wCanvasRef=$("#wcanvas"),G(),n(),gameInit(),darworms$1.dwsettings.noWhere=new Point(-1,-1),!window.location.hash&&window.addEventListener&&(window.addEventListener("load",function(){logging()&&console.log("load event listener triggered"),setTimeout(function(){window.scrollTo(0,0)},100)}),window.addEventListener("orientationchange",function(){setTimeout(function(){window.scrollTo(0,0)},100)})),$(window).bind("throttledresize orientationchange",function(e){window.scrollTo(1,0),logging()&&console.log("resize event triggered"),darworms$1.theGame&&clearCanvas(),resizeCanvas(),darworms$1.theGame&&reScale(darworms$1.theGame.grid.width,darworms$1.theGame.grid.height)}),i.forEach(function(e,t){e.setNotes(e.instrument||0)}),resizeCanvas(),$("#p1button").click(function(){darworms$1.selectedIdx=0}),$("#p2button").click(function(){darworms$1.selectedIdx=1}),$("#p3button").click(function(){darworms$1.selectedIdx=2}),$("#p4button").click(function(){darworms$1.selectedIdx=3}),$("#nextbutton").click(function(){logging()&&console.log(" nextbutton clicked"),$.mobile.changePage("#edit-darworm-page",{allowSamePageTransition:!0}),darworms$1.selectedIdx=(darworms$1.selectedIdx+1)%i.length,S(darworms$1.selectedIdx)}),$("input[name='edit-radio-choice']").on("change",function(){logging()&&console.log(" edit-radio-choice on change function");var e=$("input[name='edit-radio-choice']:checked").val();if(s[darworms$1.selectedIdx]=k(e),i[darworms$1.selectedIdx].wType=s[darworms$1.selectedIdx],i[darworms$1.selectedIdx].init(k(e)),$("#edittextfield").val(0==k(e)?"":i[darworms$1.selectedIdx].name),0==i[darworms$1.selectedIdx].wType)$("#darwormdeflabel").text("Darworm DNA"),$("#completeButton").hide();else{var t=i[darworms$1.selectedIdx].getNumGenes(darworms$1.dwsettings.codons.unSet);$("#darwormdeflabel").text(i[darworms$1.selectedIdx].wdescription),$("#darwormdeflabel").text(y(i[darworms$1.selectedIdx])),t>0?$("#completeButton").show():$("#completeButton").hide()}}),$("input[name='edit-textname']").on("change",function(){logging()&&console.log(" edit-textname");var e=$("input[name='edit-textname']").val();dnaregx.test(e)?i[darworms$1.selectedIdx].fromText(e)&&(i[darworms$1.selectedIdx].wType=2,s[darworms$1.selectedIdx]=2,d(),$(darworms$1.buttonSelectors[darworms$1.selectedIdx]).text(r[s[darworms$1.selectedIdx]]),$(darworms$1.buttonLSelectors[darworms$1.selectedIdx]).text(r[s[darworms$1.selectedIdx]]),i[darworms$1.selectedIdx].toText(),$("input[name='edit-textname']").textinput({theme:darworms$1.themes[darworms$1.selectedIdx]})):$("input[name='edit-textname']").textinput({theme:"a"})})},gWorms:i,setSelectedDarwormType:m,setupEditPage:d,applySettings:w,injectSettings:h,showSettings:c,setupGridGeometry:l,initPlayPage:function(){$("#myPages").css({overflow:"hidden",height:"100%"}),$("#wcanvasparagrap").css({background:darworms$1.dwsettings.cellBackground[darworms$1.dwsettings.backGroundTheme]}),void 0!==darworms$1.theGame&&null!==darworms$1.theGame&&darworms$1.theGame.grid.height==darworms$1.dwsettings.gridSize||(darworms$1.theGame=new Game(darworms$1.dwsettings.gridSize,darworms$1.dwsettings.gridSize),setGrid(darworms$1.theGame.grid,darworms$1.theGame)),n(),drawCells(),updateScores(darworms$1.main.gWorms),darworms$1.playpageInitialized||(resizeCanvas(),darworms$1.startgame(!1),darworms$1.audioContext.resume(),darworms$1.playpageInitialized=!0)},leavePlayPage:function(){$("#myPages").css({overflow:"auto",height:"auto"}),darworms$1.playpageInitialized||(resizeCanvas(),darworms$1.startgame(!1),darworms$1.audioContext.resume(),darworms$1.playpageInitialized=!0),$("body").css("scroll","on"),$("body").css("overflow","hidden")},wormEventHandler:u,initEditPage:S,leaveEditPage:function(e){logging()&&console.log(" leaveEditPage "+e)},loadSavedGames:function(){logging()&&console.log(" loadSavedGames "),loadGames()},freeSavedGames:function(){logging()&&console.log(" freeSavedGames "),freeGames()}}}();
//# sourceMappingURL=bundle.js.map
